<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UltraBox JSON â†’ MIDIã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ (v37.0 - æœ€é€Ÿãƒ¢ãƒ¼ãƒ‰)</title>
    <style>
        body{font-family:sans-serif;padding:20px;max-width:600px;margin:0 auto;line-height:1.6;background-color:#f4f7f6}h1{color:#1a4d6f;border-bottom:3px solid #6ac4a5;padding-bottom:10px;margin-bottom:30px}.controls{background:#fff;padding:25px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08);border:1px solid #e0e0e0}label{font-weight:700;display:block;margin-bottom:8px;color:#333}input[type=file]{margin-bottom:20px;display:block;padding:10px;border:1px solid #ccc;border-radius:6px;width:95%}button{padding:12px 25px;background-color:#007bff;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:17px;transition:background-color .2s;width:100%}button:hover:not(:disabled){background-color:#0056b3}button:disabled{background-color:#a0a0a0;cursor:not-allowed}.message{margin-top:25px;padding:15px;border-radius:8px;font-weight:700;display:block;word-break:break-all}.error{background-color:#fcebeb;color:#cc0000;border:1px solid #ecc0c0}.success{background-color:#e5f6e8;color:#0a6b32;border:1px solid #b3d9c7}.warning{background-color:#fff3cd;color:#856404;border:1px solid #ffeeba}.log-details{font-size:12px;margin-top:10px;padding:10px;background-color:#f0f0f0;border-radius:4px;white-space:pre-wrap;max-height:300px;overflow-y:auto;}
    </style>
</head>
<body>

    <h1>UltraBox JSON â†’ MIDIã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ (v37.0 - æœ€é€Ÿãƒ¢ãƒ¼ãƒ‰)</h1>
    <p>JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€æ­£ç¢ºãªMIDIãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.midï¼‰ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
    
    <div class="message success" style="display: block;">
        <strong>ã€æœ€é€Ÿãƒ¢ãƒ¼ãƒ‰ v37.0ã€‘</strong> å‡¦ç†ã®é‡ã„ã‚½ãƒ¼ãƒˆã‚’æœ€é©åŒ–ã—ã¾ã—ãŸã€‚ã‚¯ãƒ©ãƒƒã‚·ãƒ¥é˜²æ­¢ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚
    </div>

    <div class="controls">
        <label for="jsonFile">â‘  UltraBox JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
        <input type="file" id="jsonFile" accept=".json">

        <button id="convertButton" disabled>â‘¡ MIDIã«å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </div>

    <div id="messageArea" class="message" style="display: none;"></div>

    <script>
        const convertButton = document.getElementById('convertButton');
        const messageArea = document.getElementById('messageArea');

        function showMessage(text, type, logDetails = '') {
            messageArea.innerHTML = `<span>${text}</span>`;
            messageArea.className = `message ${type}`;
            messageArea.style.display = 'block';
        }
        
        function downloadFile(content, fileName, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ----------------------------------------------------------------------
        // ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ (v37.0 - ã‚½ãƒ¼ãƒˆæœ€é©åŒ–)
        // ----------------------------------------------------------------------

        const MIDI_TICKS_PER_BEAT = 24; 
        const MIDI_HEADER_CHUNK = 0x4D546864; 
        const MIDI_TRACK_CHUNK = 0x4D54726B; 
        const MIDI_FORMAT_MULTI_TRACK = 0x0001; 
        const MIDI_NOTE_ON = 0x90;
        const MIDI_NOTE_OFF = 0x80;
        const MIDI_PROGRAM_CHANGE = 0xC0; 
        const MIDI_META = 0xFF;
        const MIDI_END_OF_TRACK = 0x2F;
        const MIDI_CHANNEL_NAME = 0x03; 

        function writeVariableLengthQuantity(value) {
            let buffer = [];
            if (value === 0) return [0]; 
            do {
                let byte = value & 0x7F;
                value >>= 7;
                if (value > 0) {
                    byte |= 0x80;
                }
                buffer.unshift(byte); 
            } while (value > 0);
            return buffer;
        }

        function writeUint16(value) { return [(value >> 8) & 0xFF, value & 0xFF]; }
        function writeUint32(value) { return [(value >> 24) & 0xFF, (value >> 16) & 0xFF, (value >> 8) & 0xFF, value & 0xFF]; }

        function convertUltraBoxToMidi(ultraBoxData) {
            if (!ultraBoxData) {
                throw new Error("JSONãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚");
            }
            
            const channels = Array.isArray(ultraBoxData.channels) 
                ? ultraBoxData.channels 
                : Object.values(ultraBoxData.channels || {}); 
            
            if (channels.length === 0) {
                 throw new Error("ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚¨ãƒ©ãƒ¼: ãƒãƒ£ãƒ³ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ ('channels') ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€ç©ºã§ã™ã€‚");
            }
            
            const patterns = ultraBoxData.patterns || {}; 

            let sequenceToLoop = ultraBoxData.sequence || []; 
            if (sequenceToLoop.length === 0) {
                const firstChannelPatterns = channels[0].patterns;
                if (firstChannelPatterns && Array.isArray(firstChannelPatterns) && firstChannelPatterns.length > 0) {
                    sequenceToLoop = firstChannelPatterns;
                }
            }

            if (sequenceToLoop.length === 0) {
                 throw new Error("ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚¨ãƒ©ãƒ¼: ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ ('sequence') ãŒãƒ«ãƒ¼ãƒˆã«ã‚‚ã€æœ€åˆã®ãƒãƒ£ãƒ³ãƒãƒ«ã«ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€ç©ºã§ã™ã€‚æ›²ã®å°ç¯€æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
            }

            // --- ä»¥é™ã€æ­£å¸¸ãªãƒ‡ãƒ¼ã‚¿å‡¦ç† ---
            
            const tempoBPM = ultraBoxData.beatsPerMinute || 150;
            const tempoMicrosecondsPerBeat = Math.round(60000000 / tempoBPM); 
            
            const ultraBoxTicksPerBeat = ultraBoxData.ticksPerBeat || 4; 
            const beatsPerBar = ultraBoxData.beatsPerBar || 4;
            const midiTicksPerBar = MIDI_TICKS_PER_BEAT * beatsPerBar; 
            
            const tickScaleFactor = MIDI_TICKS_PER_BEAT / ultraBoxTicksPerBeat; 

            const trackChunks = [];
            let noteCount = 0; 
            let skippedEvents = []; 
            let logDetailsSummary = [
                `--- å¤‰æ›ã‚µãƒãƒªãƒ¼ ---`,
                `ãƒˆãƒ©ãƒƒã‚¯æ•°: ${channels.length}å€‹`,
                `å°ç¯€ãƒ«ãƒ¼ãƒ—æ•° (ã‚·ãƒ¼ã‚±ãƒ³ã‚¹é•·): ${sequenceToLoop.length}å›`,
                `1å°ç¯€ã‚ãŸã‚Šã®MIDIãƒ†ã‚£ãƒƒã‚¯: ${midiTicksPerBar}t`
            ].join('\n');

            let firstPatternErrorLogged = false; 

            // 1. å„UltraBoxãƒãƒ£ãƒ³ãƒãƒ«ï¼ˆæ¥½å™¨ï¼‰ã‚’ãƒ«ãƒ¼ãƒ—ã—ã€å€‹åˆ¥ã® MIDI ãƒˆãƒ©ãƒƒã‚¯ã‚’ä½œæˆ
            for (let channelIndex = 0; channelIndex < channels.length; channelIndex++) {
                const ultraBoxChannel = channels[channelIndex];
                const midiChannel = channelIndex % 16; 

                const ultraBoxPresetId = ultraBoxChannel.instruments?.[0]?.preset;
                const gmProgramNumber = (ultraBoxPresetId !== undefined && ultraBoxPresetId >= 0) ? ultraBoxPresetId % 128 : 0; 
                
                const instrumentType = ultraBoxChannel.instruments?.[0]?.type;
                const channelName = ultraBoxChannel.name || instrumentType || `Track ${channelIndex + 1}`;

                const events = [];
                let absoluteTick = 0;
                
                // 2. ã“ã®ãƒãƒ£ãƒ³ãƒãƒ«ã®æ›²ã®é•·ã•å…¨ä½“ã‚’å·¡å›ã—ã€çµ¶å¯¾ãƒ†ã‚£ãƒƒã‚¯ã‚’è¨ˆç®—
                for (let barIndex = 0; barIndex < sequenceToLoop.length; barIndex++) {
                    
                    const sourceSequence = ultraBoxChannel.patterns || sequenceToLoop;
                    const rawPatternRef = sourceSequence[barIndex]; 

                    let patternIndex = -1; 
                    let pattern = null;

                    if (typeof rawPatternRef === 'number' && rawPatternRef >= 0 && Number.isInteger(rawPatternRef)) {
                        // 1. æ¨™æº–: æ•°å€¤ãƒ‘ã‚¿ãƒ¼ãƒ³IDã®å ´åˆ
                        patternIndex = rawPatternRef;
                    } else if (typeof rawPatternRef === 'object' && rawPatternRef !== null) {
                        // 2. ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã®å ´åˆã®ãƒã‚§ãƒƒã‚¯ (patternIdã‚­ãƒ¼ãªã©)
                        if (typeof rawPatternRef.pattern === 'number' && rawPatternRef.pattern >= 0) {
                            patternIndex = rawPatternRef.pattern; 
                        } else if (typeof rawPatternRef.patternId === 'number' && rawPatternRef.patternId >= 0) {
                            patternIndex = rawPatternRef.patternId;
                        } else if (typeof rawPatternRef.id === 'number' && rawPatternRef.id >= 0) {
                            patternIndex = rawPatternRef.id;
                        }
                        
                        // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ»ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¤å®š
                        if (patternIndex === -1 && Array.isArray(rawPatternRef.notes)) {
                            pattern = rawPatternRef;
                        }
                    } 
                    
                    // ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ã®ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ— (ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ãªã„å ´åˆ)
                    if (pattern === null && patternIndex >= 0) {
                        if (Array.isArray(patterns)) {
                            pattern = patterns[patternIndex];
                        } else {
                            pattern = patterns[String(patternIndex)];
                        }
                    }
                    
                    // --- ãƒãƒ¼ãƒˆã®å‡¦ç† ---
                    if (pattern && pattern.notes && Array.isArray(pattern.notes)) {
                        
                        if (pattern.notes.length === 0) {
                            skippedEvents.push(`[Ch${channelIndex+1} Bar${barIndex+1}] ç†ç”±: å‚ç…§ã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã«éŸ³ç¬¦ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ (notes: [])`);
                            absoluteTick += midiTicksPerBar; 
                            continue;
                        }

                        for (let noteIndex = 0; noteIndex < pattern.notes.length; noteIndex++) {
                            const note = pattern.notes[noteIndex];
                            
                            // éŸ³é«˜ã®æŠ½å‡º (çœç•¥)
                            const pitches = (Array.isArray(note.pitches) && note.pitches.length > 0) 
                                ? note.pitches 
                                : (Array.isArray(note.pitch) ? note.pitch : [note.pitch]); 
                            if (!pitches || pitches.length === 0) {
                                skippedEvents.push(`[Ch${channelIndex+1} Bar${barIndex+1}, Note${noteIndex}] ç†ç”±: éŸ³é«˜ãƒ‡ãƒ¼ã‚¿(pitches/pitch)ãŒè¦‹ã¤ã‹ã‚‰ãªã„`);
                                continue;
                            }

                            // é–‹å§‹ãƒ†ã‚£ãƒƒã‚¯ã®å–å¾— (çœç•¥)
                            let ultraBoxStart = note.start;
                            let pointsValid = note.points && Array.isArray(note.points) && note.points.length > 0;
                            
                            if ((ultraBoxStart === undefined || ultraBoxStart === null) && pointsValid && typeof note.points[0].tick === 'number') {
                                ultraBoxStart = note.points[0].tick;
                            }

                            // æŒç¶šæ™‚é–“ã®æŠ½å‡º (çœç•¥)
                            let ultraBoxDuration = 0;
                            
                            if (pointsValid) {
                                ultraBoxDuration = note.points[note.points.length - 1].tick;
                            } else if (typeof note.duration === 'number' && note.duration > 0) {
                                ultraBoxDuration = note.duration; 
                            }
                            
                            // ãƒ‡ãƒ¼ã‚¿ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯ (çœç•¥)
                            if (ultraBoxStart === undefined || typeof ultraBoxStart !== 'number' || ultraBoxDuration <= 0) {
                                let reason = `é–‹å§‹ãƒ†ã‚£ãƒƒã‚¯: ${ultraBoxStart} (${typeof ultraBoxStart}), æŒç¶šæ™‚é–“: ${ultraBoxDuration}`;
                                skippedEvents.push(`[Ch${channelIndex+1} Bar${barIndex+1}, Note${noteIndex}] ç†ç”±: é–‹å§‹ä½ç½®ã¾ãŸã¯æŒç¶šæ™‚é–“ãŒä¸æ­£ (${reason})`);
                                continue;
                            }

                            // UltraBoxãƒ†ã‚£ãƒƒã‚¯ã‚’ MIDIãƒ†ã‚£ãƒƒã‚¯ã«å¤‰æ› (çœç•¥)
                            const midiDuration = Math.round(ultraBoxDuration * tickScaleFactor);
                            const midiStart = Math.round(ultraBoxStart * tickScaleFactor); 

                            if (midiDuration <= 0) {
                                skippedEvents.push(`[Ch${channelIndex+1} Bar${barIndex+1}, Note${noteIndex}] ç†ç”±: MIDIæŒç¶šæ™‚é–“(${midiDuration}t)ãŒ0ä»¥ä¸‹`);
                                continue;
                            }

                            // éŸ³é‡ï¼ˆvolumeï¼‰ã®å–å¾— (çœç•¥)
                            let volumeValue = 10;
                            if (pointsValid && typeof note.points[0].volume === 'number') {
                                volumeValue = note.points[0].volume;
                            } else if (typeof note.volume === 'number') {
                                volumeValue = note.volume;
                            }
                            
                            const maxVolume = volumeValue > 10 ? 100 : 10;
                            const velocity = Math.min(127, Math.max(1, Math.round(volumeValue * 127 / maxVolume)));


                            for (const pitchValue of pitches) {
                                
                                if (typeof pitchValue !== 'number' || pitchValue < 0 || pitchValue > 127) {
                                    skippedEvents.push(`[Ch${channelIndex+1} Bar${barIndex+1}, Note${noteIndex}] ç†ç”±: éŸ³é«˜(${pitchValue})ãŒMIDIç¯„å›²å¤–`);
                                    continue;
                                }

                                // Note On/Off ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
                                events.push({
                                    tick: absoluteTick + midiStart, type: MIDI_NOTE_ON, pitch: pitchValue, velocity: velocity, channel: midiChannel 
                                });
                                events.push({
                                    tick: absoluteTick + midiStart + midiDuration, type: MIDI_NOTE_OFF, pitch: pitchValue, velocity: 0, channel: midiChannel 
                                });
                                noteCount++; 
                            }
                        }
                    } else {
                        // ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„/æ§‹é€ ãŒä¸æ­£ (IDå‚ç…§å¤±æ•—ã¨ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åˆ¤å®šå¤±æ•—)
                        let rawDataString = "";
                         if (!firstPatternErrorLogged) { 
                            // ğŸ’¡ v37.0: JSON.stringifyã‚’å‰Šé™¤ã—ã€ã‚¯ãƒ©ãƒƒã‚·ãƒ¥åŸå› ã¨ãªã‚‹ãƒ¡ãƒ¢ãƒªè² è·ã‚’é¿ã‘ã‚‹
                            if (typeof rawPatternRef === 'object' && rawPatternRef !== null) {
                                rawDataString = `å‚ç…§ã‚­ãƒ¼: ${Object.keys(rawPatternRef).join(', ')}`;
                            } else {
                                rawDataString = `å‚ç…§ãƒ‡ãƒ¼ã‚¿å‹: ${typeof rawPatternRef}, å€¤: ${rawPatternRef}`;
                            }
                            firstPatternErrorLogged = true;
                        } else {
                             rawDataString = `(æœ€åˆã®ãƒ‘ã‚¿ãƒ¼ãƒ³å‚ç…§ã‚¨ãƒ©ãƒ¼[Ch1 Bar1]ã«ã¦è¨ºæ–­æƒ…å ±å‡ºåŠ›æ¸ˆã¿)`;
                        }
                        
                        skippedEvents.push(`[Ch${channelIndex+1} Bar${barIndex+1}] ç†ç”±: ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•— (ID: ${patternIndex})\n>> è¨ºæ–­æƒ…å ±:\n${rawDataString}`);
                    }
                    absoluteTick += midiTicksPerBar; 
                }
                
                // ğŸ’¡ v37.0: æœ€é©åŒ–ã•ã‚ŒãŸã‚½ãƒ¼ãƒˆå‡¦ç†
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆã®ã‚½ãƒ¼ãƒˆã¯æœ€ã‚‚é‡ã„å‡¦ç†ã€‚ã“ã“ã§ä¸€åº¦ã ã‘å®Ÿè¡Œã™ã‚‹ã€‚
                events.sort((a, b) => a.tick - b.tick);
                
                // 4. MIDIãƒˆãƒ©ãƒƒã‚¯ãƒãƒ£ãƒ³ã‚¯ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰ (çœç•¥)
                const trackEvents = [];
                let lastTick = 0;

                const nameBytes = Array.from(new TextEncoder().encode(channelName));

                trackEvents.push(
                    ...writeVariableLengthQuantity(0), MIDI_META, MIDI_CHANNEL_NAME, 
                    ...writeVariableLengthQuantity(nameBytes.length), 
                    ...nameBytes
                );
                
                trackEvents.push(
                    ...writeVariableLengthQuantity(0), 
                    MIDI_PROGRAM_CHANGE | midiChannel, 
                    gmProgramNumber 
                );

                for (const event of events) {
                    const deltaTime = event.tick - lastTick;
                    if (deltaTime < 0) throw new Error("MIDI Time Error: Negative delta time.");

                    trackEvents.push(
                        ...writeVariableLengthQuantity(deltaTime), 
                        event.type | event.channel, 
                        event.pitch, 
                        event.velocity 
                    );

                    lastTick = event.tick;
                }

                trackEvents.push(
                    ...writeVariableLengthQuantity(0), MIDI_META, MIDI_END_OF_TRACK, 0x00 
                );
                
                const trackSize = trackEvents.length;
                const trackChunk = [
                    ...writeUint32(MIDI_TRACK_CHUNK), 
                    ...writeUint32(trackSize), 
                    ...trackEvents
                ];
                trackChunks.push(trackChunk);
            }
            
            // 5. ãƒ†ãƒ³ãƒãƒˆãƒ©ãƒƒã‚¯ã‚’ä½œæˆ (çœç•¥)
            const tempoTrackEvents = [];
            tempoTrackEvents.push(
                ...writeVariableLengthQuantity(0), MIDI_META, 0x51, 0x03, 
                ...writeUint32(tempoMicrosecondsPerBeat).slice(1) 
            );
            tempoTrackEvents.push(
                ...writeVariableLengthQuantity(0), MIDI_META, MIDI_END_OF_TRACK, 0x00 
            );
            
            const tempoTrackChunk = [
                ...writeUint32(MIDI_TRACK_CHUNK), 
                ...writeUint32(tempoTrackEvents.length), 
                ...tempoTrackEvents
            ];

            // 6. ãƒ˜ãƒƒãƒ€ãƒ¼ã¨å…¨ãƒˆãƒ©ãƒƒã‚¯ãƒãƒ£ãƒ³ã‚¯ã‚’çµåˆ (çœç•¥)
            const totalTracks = trackChunks.length + 1; 
            const header = [
                ...writeUint32(MIDI_HEADER_CHUNK), ...writeUint32(6), 
                ...writeUint16(MIDI_FORMAT_MULTI_TRACK), 
                ...writeUint16(totalTracks), 
                ...writeUint16(MIDI_TICKS_PER_BEAT) 
            ];

            const fullMidi = [...header, ...tempoTrackChunk];
            trackChunks.forEach(chunk => fullMidi.push(...chunk));

            return { 
                midiBuffer: new Uint8Array(fullMidi).buffer,
                noteCount: noteCount, 
                skippedEvents: skippedEvents,
                summary: logDetailsSummary 
            }; 
        }

        // ----------------------------------------------------------------------
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ (v37.0)
        // ----------------------------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('jsonFile');
            
            showMessage('âœ… å¤‰æ›æ©Ÿèƒ½ã®æº–å‚™å®Œäº†ã€‚JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'success');

            fileInput.addEventListener('change', (e) => {
                showMessage('', 'none');
                convertButton.disabled = true;
                const file = e.target.files[0];
                
                if (!file) return;

                showMessage(`ğŸ” ãƒ•ã‚¡ã‚¤ãƒ« [${file.name}] ã®èª­ã¿è¾¼ã¿ã‚’é–‹å§‹ã—ã¾ã—ãŸ...`, 'success'); 

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const ultraBoxData = JSON.parse(event.target.result);
                        
                        if (ultraBoxData && (ultraBoxData.format === "UltraBox" || ultraBoxData.format === "BeepBox")) {
                            convertButton.ultraBoxData = ultraBoxData;
                            convertButton.fileName = file.name.replace(/\.json$/i, ''); 
                            convertButton.disabled = false;
                            showMessage(`âœ… ã€Œ${file.name}ã€ã®èª­ã¿è¾¼ã¿ã«æˆåŠŸã—ã¾ã—ãŸã€‚å¤‰æ›ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`, 'success');
                        } else {
                            throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒUltraBox/BeepBoxã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`);
                        }
                    } catch (error) {
                        showMessage(`âŒ ãƒ•ã‚¡ã‚¤ãƒ«è§£æå¤±æ•—: ${error.message}`, 'error');
                        convertButton.ultraBoxData = null;
                    }
                };
                
                reader.readAsText(file);
            });

            convertButton.addEventListener('click', () => {
                if (!convertButton.ultraBoxData) {
                    showMessage('âŒ å¤‰æ›ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚', 'error');
                    return;
                }

                convertButton.disabled = true;
                showMessage('ğŸ”„ MIDIã¸ã®å¤‰æ›ã‚’é–‹å§‹ã—ã¾ã—ãŸ...', 'warning');
                
                try {
                    const result = convertUltraBoxToMidi(convertButton.ultraBoxData);
                    
                    const baseFileName = convertButton.fileName;

                    // 1. MIDIãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    const midiFileName = baseFileName + '_fixed_multitrack.mid';
                    downloadFile(result.midiBuffer, midiFileName, "audio/midi");
                    
                    // 2. ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä½œæˆ
                    let logContent = `${result.summary}\n\n`;
                    logContent += `--- ã‚¹ã‚­ãƒƒãƒ—ãƒ»ç©ºå°ç¯€ è©³ç´°ãƒ­ã‚° ---\n`;
                    logContent += `ã‚¹ã‚­ãƒƒãƒ—ãƒ»ç©ºå°ç¯€ç·æ•°: ${result.skippedEvents.length}å€‹\n\n`;
                    logContent += result.skippedEvents.length > 0 ? result.skippedEvents.join('\n') : "ã€æˆåŠŸã€‘ãƒ‘ã‚¿ãƒ¼ãƒ³å‚ç…§ã‚¨ãƒ©ãƒ¼ã‚„å‡¦ç†ä¸èƒ½ãªéŸ³ç¬¦ãƒ‡ãƒ¼ã‚¿ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚";

                    // 3. ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    const logFileName = baseFileName + '_log.txt';
                    // ãƒ­ã‚°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¯MIDIãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã®ã™ãå¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹ï¼ˆé€£ç¶šãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
                    setTimeout(() => { 
                        downloadFile(logContent, logFileName, "text/plain");
                    }, 500); // ã‚ãšã‹ãªé…å»¶ã‚’è¨­ã‘ã¦ã€2ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒç¢ºå®Ÿã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹

                    if (result.noteCount > 0) {
                        showMessage(
                            `ğŸ‰ å¤‰æ›å®Œäº†ï¼**MIDIãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«**ã‚’é€£ç¶šãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚(ãƒãƒ¼ãƒˆç·æ•°: ${result.noteCount}å€‹)`, 
                            'success'
                        );
                    } else {
                        showMessage(
                            `âš ï¸ å¤‰æ›å®Œäº†ã€‚ãŸã ã—ã€éŸ³ç¬¦ãŒä¸€ã¤ã‚‚è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚(ãƒãƒ¼ãƒˆç·æ•°: 0å€‹)ã€‚ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`, 
                            'warning'
                        );
                    }
                    
                    convertButton.disabled = false;

                } catch (error) {
                    showMessage(`ğŸ’¥ å¤‰æ›å‡¦ç†ä¸­ã«è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'error');
                    convertButton.disabled = false;
                }
            });
        });
    </script>

</body>
</html>
