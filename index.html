<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UltraBox JSON â†’ MIDIã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼</title>
    <style>
        /* CSSã‚¹ã‚¿ã‚¤ãƒ«ã¯åœ§ç¸®æ¸ˆã¿ */
        body{font-family:sans-serif;padding:20px;max-width:600px;margin:0 auto;line-height:1.6;background-color:#f4f7f6}h1{color:#1a4d6f;border-bottom:3px solid #6ac4a5;padding-bottom:10px;margin-bottom:30px}.controls{background:#fff;padding:25px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08);border:1px solid #e0e0e0}label{font-weight:700;display:block;margin-bottom:8px;color:#333}input[type=file]{margin-bottom:20px;display:block;padding:10px;border:1px solid #ccc;border-radius:6px;width:95%}button{padding:12px 25px;background-color:#007bff;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:17px;transition:background-color .2s;width:100%}button:hover:not(:disabled){background-color:#0056b3}button:disabled{background-color:#a0a0a0;cursor:not-allowed}.message{margin-top:25px;padding:15px;border-radius:8px;font-weight:700;display:none;word-break:break-all}.error{background-color:#fcebeb;color:#cc0000;border:1px solid #ecc0c0}.success{background-color:#e5f6e8;color:#0a6b32;border:1px solid #b3d9c7}
    </style>
</head>
<body>

    <h1>UltraBox JSON â†’ MIDIã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼</h1>
    <p>JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€ä¼¸ã°ã—éŸ³ãŒåˆ‡æ–­ã•ã‚Œãªã„æ­£ç¢ºãªMIDIãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.midï¼‰ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>

    <div class="controls">
        <label for="jsonFile">â‘  UltraBox JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
        <input type="file" id="jsonFile" accept=".json">

        <button id="convertButton" disabled>â‘¡ MIDIã«å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </div>

    <div id="messageArea" class="message" style="display: none;"></div>

    <script>
        // ğŸš€ åœ§ç¸®ã•ã‚ŒãŸã‚³ã‚¢ã‚³ãƒ¼ãƒ‰ã®æ–‡å­—åˆ—
        // ã“ã‚ŒãŒMidiWriterã¨å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯ã®ã™ã¹ã¦ã§ã™ã€‚
        const CORE_SCRIPT_MINIFIED = "let generateMidi;let downloadMidi;let MidiWriter;let coreLoaded=false;function loadAndExecuteCore(){MidiWriter=function(){var a=Object.create(null);function b(b){var c=a[b];if(void 0!==c)return c;var d=a[b]={exports:{}};return b(d.exports,d),d.exports}return b.r=function(a){\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(a,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(a,\"__esModule\",{value:!0})},b.d=function(a,b){for(var c in b)b.hasOwnProperty(c)&&!a.hasOwnProperty(c)&&Object.defineProperty(a,c,{enumerable:!0,get:b[c]})},b.o=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)},b.p=\"\",b(2).default}({2:function(a,b,c){c.r(b);var d={pitch:null,duration:\"4\",wait:null,sequential:!1,velocity:50,channel:null},e=function(a){this.tickDuration=a||128,this.events=[]};e.prototype.addEvent=function(a,b){var c;a instanceof Array?c=a:a.events?c=a.events:c=[a];var d=this,e=function(){if(b){var a=b(d,c);a&&a.sequential&&d.setSequential(c)}d.events=d.events.concat(c)};return d.events.length>0?d.events[d.events.length-1].duration?e():e():e(),this},e.prototype.setInstrument=function(a){return this.addEvent(new n(a)),this},e.prototype.addNote=function(a){var b=this;a instanceof Array?a.forEach(function(a){b.addEvent(new g(a))}):b.addEvent(new g(a))},e.prototype.addTrackName=function(a){return this.addEvent(new k({text:a})),this},e.prototype.addCopyright=function(a){return this.addEvent(new l({text:a})),this},e.prototype.addText=function(a){return this.addEvent(new m({text:a})),this},e.prototype.addMarker=function(a){return this.addEvent(new o({text:a})),this},e.prototype.addCuePoint=function(a){return this.addEvent(new p({text:a})),this},e.prototype.addTempo=function(a){return this.addEvent(new j({bpm:a})),this},e.prototype.setChannel=function(a){return this.addEvent(new h({channel:a})),this},e.prototype.setPitchBend=function(a){return this.addEvent(new r({msb:a})),this},e.prototype.setModulation=function(a){return this.addEvent(new q({msb:a})),this},e.prototype.setPan=function(a){return this.addEvent(new s({msb:a})),this},e.prototype.setVolume=function(a){return this.addEvent(new t({msb:a})),this},e.prototype.setTickDuration=function(a){this.tickDuration=a},e.prototype.setSequential=function(a){var b=0;return a.forEach(function(c){c.wait=0,c.duration&&(c.wait=b),b=c.duration}),this};var f=function(){this.tracks=[],this.type=0,this.ticksPerBeat=128};f.prototype.addTrack=function(a){return this.tracks.push(a),this},f.prototype.buildFile=function(){for(var a=this.ticksPerBeat,b=this.tracks,c=[],d=0;d<b.length;d++){var e=new u(a,b[d].events,d,b[d].tickDuration);c=c.concat(e.toArray())}var f=new v(c,this.type,a);return f.build()};var g=function(a){this.id=function(){return\"NoteEvent\"},this.events=this.get=[].concat(a.pitch).map(function(b){return new w(Object.assign({},d,a,{pitch:b}))})};g.prototype.set=function(a){return this.events.forEach(function(b){b.set(a)}),this};var h=function(a){this.id=function(){return\"ChannelEvent\"},this.events=[new x(a)]};h.prototype.set=function(a){this.events[0].set(a)};var i=function(a){this.id=function(){return\"ControlChangeEvent\"},this.events=[new y(a)]};i.prototype.set=function(a){this.events[0].set(a)};var j=function(a){this.id=function(){return\"TempoEvent\"},this.events=[new z(a)]};j.prototype.set=function(a){this.events[0].set(a)};var k=function(a){this.id=function(){return\"TrackNameEvent\"},this.events=[new A(a)]};k.prototype.set=function(a){this.events[0].set(a)};var l=function(a){this.id=function(){return\"CopyrightEvent\"},this.events=[new B(a)]};l.prototype.set=function(a){this.events[0].set(a)};var m=function(a){this.id=function(){return\"TextEvent\"},this.events=[new C(a)]};m.prototype.set=function(a){this.events[0].set(a)};var n=function(a){this.id=function(){return\"ProgramChangeEvent\"},this.events=[new D(a)]};n.prototype.set=function(a){this.events[0].set(a)};var o=function(a){this.id=function(){return\"MarkerEvent\"},this.events=[new E(a)]};o.prototype.set=function(a){this.events[0].set(a)};var p=function(a){this.id=function(){return\"CuePointEvent\"},this.events=[new F(a)]};p.prototype.set=function(a){this.events[0].set(a)};var q=function(a){this.id=function(){return\"ModulationEvent\"},this.events=[new G(a)]};q.prototype.set=function(a){this.events[0].set(a)};var r=function(a){this.id=function(){return\"PitchBendEvent\"},this.events=[new H(a)]};r.prototype.set=function(a){this.events[0].set(a)};var s=function(a){this.id=function(){return\"PanEvent\"},this.events=[new I(a)]};s.prototype.set=function(a){this.events[0].set(a)};var t=function(a){this.id=function(){return\"VolumeEvent\"},this.events=[new J(a)]};t.prototype.set=function(a){this.events[0].set(a)};var u=function(a,b,c,d){this.tickDuration=d||128,this.ticksPerBeat=a||128,this.events=b,this.channel=c,this.tickMap={whole:this.ticksPerBeat*4,half:this.ticksPerBeat*2,quarter:this.ticksPerBeat,8:this.ticksPerBeat/2,16:this.ticksPerBeat/4,32:this.ticksPerBeat/8,64:this.ticksPerBeat/16,128:this.ticksPerBeat/32}};u.prototype.toArray=function(){var a=this,b=a.events,c=[];a.setEventTicks(b);var d=0;return b.forEach(function(b){if(b.tick>0)c=c.concat(a.getDelta(b.tick));else{var e=b.getEvent()}c=c.concat(e),d+=b.tick}),c.concat([255,47,0])};u.prototype.setEventTicks=function(a){var b=this;a.forEach(function(a){var c=a.wait,d=a.duration;if(a.duration=\"string\"==typeof d?b.tickMap[d.replace(/[^\w]/g,\"\")]||b.tickMap[d]:d,a.tick=a.duration,a.wait){var e=\"string\"==typeof c?b.tickMap[c.replace(/[^\w]/g,\"\")]||b.tickMap[c]:c;a.tick=e}var f=a.getEvent;a.getEvent=function(){var b=f();return a.channel?(b[0]=b[0]|a.channel-1):b[0],b}})};u.prototype.getDelta=function(a){var b,c=[];if(a=Math.round(a),0===a)return[0];do{b=127&a,a>>=7,a>0&&(b|=128),c.push(b)}while(a>0);return c.reverse()};var v=function(a,b,c){this.tracks=a,this.type=b||0,this.ticksPerBeat=c||128};v.prototype.build=function(){var a=[77,84,104,100,0,0,0,6,0,this.type,0,this.tracks.length,this.ticksPerBeat>>8,255&this.ticksPerBeat];return this.tracks.forEach(function(b){a=a.concat([77,84,114,107,b.length>>24&255,b.length>>16&255,b.length>>8&255,255&b.length]),a=a.concat(b)}),new Uint8Array(a)};var w=function(a){this.set(a),this.noteOff,this.noteOn},x=function(a){this.set(a),this.getEvent=function(){return[176,32,this.msb]}},y=function(a){this.set(a),this.getEvent=function(){return[176,this.controller,this.msb]}},z=function(a){this.set(a),this.getEvent=function(){var b=6e4/this.bpm,c=[255,81,3,b>>16&255,b>>8&255,255&b];return c}};var A=function(a){this.set(a),this.getEvent=function(){return[255,3,this.text.length].concat(this.text.split(\"\").map(function(a){return a.charCodeAt()}))}},B=function(a){this.set(a),this.getEvent=function(){return[255,2,this.text.length].concat(this.text.split(\"\").map(function(a){return a.charCodeAt()}))}},C=function(a){this.set(a),this.getEvent=function(){return[255,1,this.text.length].concat(this.text.split(\"\").map(function(a){return a.charCodeAt()}))}},D=function(a){this.set(a),this.getEvent=function(){return[192,this.instrument]}},E=function(a){this.set(a),this.getEvent=function(){return[255,6,this.text.length].concat(this.text.split(\"\").map(function(a){return a.charCodeAt()}))}},F=function(a){this.set(a),this.getEvent=function(){return[255,7,this.text.length].concat(this.text.split(\"\").map(function(a){return a.charCodeAt()}))}},G=function(a){this.set(a),this.getEvent=function(){return[176,1,this.msb]}},H=function(a){this.set(a),this.getEvent=function(){return[224,this.lsb,this.msb]}},I=function(a){this.set(a),this.getEvent=function(){return[176,10,this.msb]}},J=function(a){this.set(a),this.getEvent=function(){return[176,7,this.msb]}},K=function(a){var b=a.id();\"NoteEvent\"===b&&(this.noteOff=new L({pitch:a.pitch,duration:a.duration,velocity:0})),\"NoteEvent\"===b&&(this.noteOn=new M({pitch:a.pitch,velocity:a.velocity,duration:a.wait}));var c=this;Object.keys(a).forEach(function(b){c[b]=a[b]})};K.prototype.getEvent=function(){return this.noteOff?[].concat(this.noteOn.getEvent(),this.noteOff.getEvent()):this.noteOn?this.noteOn.getEvent():[]},K.prototype.set=function(a){var b=this;Object.keys(a).forEach(function(c){c===\"pitch\"?b[c]=MidiWriter.Utils.toNoteNumber(a[c]):b[c]=a[c]})};var L=function(a){this.set(a),this.getEvent=function(){return[128,this.pitch,this.velocity]}};L.prototype.set=K.prototype.set;var M=function(a){this.set(a),this.getEvent=function(){return[144,this.pitch,this.velocity]}};M.prototype.set=K.prototype.set;var N=function(){this.transpose=function(a,b){return b.forEach(function(c){var d=c.pitch;c.pitch=MidiWriter.Utils.toNoteNumber(d)+a})},this.toNoteNumber=function(a){return typeof a===\"string\"?MidiWriter.Utils.noteNameToNoteNumber(a):a},this.noteNameToNoteNumber=function(a){var b=a.match(/([a-gA-G])(#|b)?([0-9\-])/);if(!b)return null;var c=b[1].toUpperCase(),d=b[2]||\"\",e=parseInt(b[3],10),f=0;switch(c){case\"C\":f=0;break;case\"D\":f=2;break;case\"E\":f=4;break;case\"F\":f=5;break;case\"G\":f=7;break;case\"A\":f=9;break;case\"B\":f=11}switch(d){case\"#\":f+=1;break;case\"b\":f-=1}return 12*(e+1)+f}};Object.assign(K.prototype,{set:K.prototype.set,tick:0,channel:0,pitch:60,velocity:50,duration:128,wait:0}),Object.assign(w.prototype,{getEvent:K.prototype.getEvent,set:K.prototype.set,noteOff:L.prototype,noteOn:M.prototype}),Object.assign(L.prototype,{getEvent:L.prototype.getEvent,set:L.prototype.set,pitch:60,velocity:50}),Object.assign(M.prototype,{getEvent:M.prototype.getEvent,set:L.prototype.set,pitch:60,velocity:50}),Object.assign(x.prototype,{getEvent:x.prototype.getEvent,set:K.prototype.set,msb:0}),Object.assign(y.prototype,{getEvent:y.prototype.getEvent,set:K.prototype.set,controller:0,msb:0}),Object.assign(z.prototype,{getEvent:z.prototype.getEvent,set:K.prototype.set,bpm:120}),Object.assign(A.prototype,{getEvent:A.prototype.getEvent,set:K.prototype.set,text:\"\"}),Object.assign(B.prototype,{getEvent:B.prototype.getEvent,set:K.prototype.set,text:\"\"}),Object.assign(C.prototype,{getEvent:C.prototype.getEvent,set:K.prototype.set,text:\"\"}),Object.assign(D.prototype,{getEvent:D.prototype.getEvent,set:K.prototype.set,instrument:0}),Object.assign(E.prototype,{getEvent:E.prototype.getEvent,set:K.prototype.set,text:\"\"}),Object.assign(F.prototype,{getEvent:F.prototype.getEvent,set:K.prototype.set,text:\"\"}),Object.assign(G.prototype,{getEvent:G.prototype.getEvent,set:K.prototype.set,msb:0}),Object.assign(H.prototype,{getEvent:H.prototype.getEvent,set:K.prototype.set,lsb:0,msb:64}),Object.assign(I.prototype,{getEvent:I.prototype.getEvent,set:K.prototype.set,msb:64}),Object.assign(J.prototype,{getEvent:J.prototype.getEvent,set:K.prototype.set,msb:100});var O={Writer:f,Track:e,NoteEvent:g,ProgramChangeEvent:n,NoteOnEvent:M,NoteOffEvent:L,ChannelEvent:x,ControlChangeEvent:i,TempoEvent:z,TrackNameEvent:A,CopyrightEvent:B,TextEvent:C,MarkerEvent:E,CuePointEvent:F,PitchBendEvent:H,ModulationEvent:G,PanEvent:I,VolumeEvent:J,Utils:new N};MidiWriter=O;generateMidi=function(data){const writer=new MidiWriter.Writer();const{beatsPerMinute:bpm,ticksPerBeat,loopBars,beatsPerBar,channels,patterns}=data;if(!bpm||!ticksPerBeat||!loopBars||!beatsPerBar||!channels||!patterns){throw new Error(\"JSONã«å¿…è¦ãªåŸºæœ¬è¨­å®šãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚\")}channels.forEach((channel,channelIndex)=>{if(\"pitch\"!==channel.type&&\"drum\"!==channel.type)return;const track=new MidiWriter.Track();track.setTempo(bpm);let midiChannel=channelIndex+1;\"drum\"===channel.type&&(midiChannel=10);track.setChannel(midiChannel);channel.name&&track.addTrackName(channel.name);if(\"pitch\"===channel.type){const gmInstrument=channelIndex%127+1;track.addEvent(new MidiWriter.ProgramChangeEvent({instrument:gmInstrument}))}const volume=channel.instruments[0]?Math.max(1,Math.min(127,Math.round(channel.instruments[0].volume*1.27))):100;track.addEvent(new MidiWriter.ControlChangeEvent({controller:7,value:volume}));const trackEvents=[];let currentBarStartTick=0;const barLengthTicks=beatsPerBar*ticksPerBeat;for(let barIndex=0;barIndex<loopBars;barIndex++){const patternIndex=channel.sequence[barIndex];const patternData=patterns[patternIndex];if(!patternData||!patternData.notes||0===patternData.notes.length){currentBarStartTick+=barLengthTicks;continue}patternData.notes.forEach(note=>{const noteStartTick=currentBarStartTick+note.start;const durationTicks=note.duration;const velocity=note.volume?Math.max(1,Math.min(127,Math.round(note.volume*1.27))):100;note.pitches.forEach(pitch=>{trackEvents.push({type:\"on\",tick:noteStartTick,pitch:pitch,velocity:velocity}),trackEvents.push({type:\"off\",tick:noteStartTick+durationTicks,pitch:pitch})})});currentBarStartTick+=barLengthTicks}trackEvents.sort((a,b)=>a.tick-b.tick);let lastTick=0;trackEvents.forEach(event=>{const deltaTime=event.tick-lastTick;if(deltaTime<0)return;\"on\"===event.type?track.addEvent(new MidiWriter.NoteOnEvent({pitch:[event.pitch],velocity:event.velocity,duration:\"T\"+deltaTime})):\"off\"===event.type&&track.addEvent(new MidiWriter.NoteOffEvent({pitch:[event.pitch],duration:\"T\"+deltaTime}));lastTick=event.tick});writer.addTrack(track)});return writer.buildArrayBuffer()};downloadMidi=function(arrayBuffer,fileName){const blob=new Blob([arrayBuffer],{type:\"audio/midi\"});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`${fileName}_fixed.mid`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url)};coreLoaded=true;";
        
        
        // æœ€çµ‚çš„ãªUIåˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ (é…å»¶å®Ÿè¡Œ)
        
        let coreLoaded = false;
        
        function showMessage(text, type) {
            const messageArea = document.getElementById('messageArea');
            if (!messageArea) return;
            messageArea.textContent = text;
            messageArea.className = `message ${type}`;
            messageArea.style.display = 'block';
        }
        
        function loadAndExecuteCoreDelayed() {
            showMessage('ğŸ”„ é‡ã„å¤‰æ›ã‚³ã‚¢ã‚³ãƒ¼ãƒ‰ã‚’è§£æãƒ»å®Ÿè¡Œä¸­ã§ã™... (é…å»¶å®Ÿè¡Œ)', 'success');
            
            try {
                // ç©¶æ¥µã«åœ§ç¸®ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’è©•ä¾¡(å®Ÿè¡Œ)ã™ã‚‹
                // ã“ã‚Œã«ã‚ˆã‚Šã€generateMidi, downloadMidi é–¢æ•°ãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ã•ã‚Œã‚‹
                eval(CORE_SCRIPT_MINIFIED);
                coreLoaded = true;
                showMessage('âœ… å¤‰æ›æ©Ÿèƒ½ã®æº–å‚™å®Œäº†ã€‚JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'success');
            } catch (e) {
                 // iPadã§ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãŸå ´åˆã€ã“ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡ºã‚‹
                 showMessage('âŒ å¤‰æ›ã‚³ã‚¢ã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ‡ãƒã‚¤ã‚¹ã®ãƒ¡ãƒ¢ãƒªé™ç•Œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚', 'error');
                 console.error("Core execution error:", e);
                 coreLoaded = false;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('jsonFile');
            const convertButton = document.getElementById('convertButton');
            
            showMessage('ğŸ‰ ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æˆåŠŸï¼', 'success');

            // 1ç§’å¾Œï¼ˆiPadãŒUIã‚’ãƒ­ãƒ¼ãƒ‰ã—çµ‚ãˆãŸå¾Œï¼‰ã«ã€åœ§ç¸®ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã®è§£æã¨å®Ÿè¡Œã‚’é–‹å§‹
            setTimeout(loadAndExecuteCoreDelayed, 1000); 

            fileInput.addEventListener('change', (e) => {
                showMessage('', 'none');
                convertButton.disabled = true;
                const file = e.target.files[0];
                
                if (!file) return showMessage('âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');

                if (!coreLoaded) return showMessage('ğŸ”„ å¤‰æ›æ©Ÿèƒ½ãŒã¾ã æº–å‚™ä¸­ã§ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');

                showMessage(`ğŸ” ãƒ•ã‚¡ã‚¤ãƒ« [${file.name}] ã®èª­ã¿è¾¼ã¿ã‚’é–‹å§‹ã—ã¾ã—ãŸ...`, 'success'); 

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const ultraBoxData = JSON.parse(event.target.result);
                        
                        if (ultraBoxData && (ultraBoxData.format === "UltraBox" || ultraBoxData.format === "BeepBox")) {
                            convertButton.disabled = false;
                            convertButton.ultraBoxData = ultraBoxData;
                            showMessage(`âœ… ã€Œ${file.name}ã€ã®èª­ã¿è¾¼ã¿ã«æˆåŠŸã—ã¾ã—ãŸã€‚å¤‰æ›ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`, 'success');
                        } else {
                            throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒUltraBox/BeepBoxã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`);
                        }
                    } catch (error) {
                        showMessage(`âŒ ãƒ•ã‚¡ã‚¤ãƒ«è§£æå¤±æ•—: ${error.message}`, 'error');
                        convertButton.ultraBoxData = null;
                    }
                };
                
                reader.readAsText(file);
            });

            convertButton.addEventListener('click', () => {
                // generateMidiã‚„downloadMidiãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (!coreLoaded || !convertButton.ultraBoxData || typeof generateMidi === 'undefined') return showMessage('âŒ å¤‰æ›æ©Ÿèƒ½ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');

                const ultraBoxData = convertButton.ultraBoxData;
                convertButton.disabled = true;
                showMessage('ğŸ”„ MIDIã«å¤‰æ›ä¸­ã§ã™...', 'success');
                
                // å¤‰æ›å‡¦ç†ã‚’å¾®å°é…å»¶ã•ã›ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã®è² è·ã‚’èª¿æ•´
                setTimeout(() => {
                    try {
                        const midiArrayBuffer = generateMidi(ultraBoxData); 
                        downloadMidi(midiArrayBuffer, ultraBoxData.name || "untitled");
                        showMessage('ğŸ‰ MIDIãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼', 'success');
                    } catch (error) {
                        showMessage(`ğŸ’¥ å¤‰æ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'error');
                        console.error(error);
                    } finally {
                        convertButton.disabled = false;
                    }
                }, 10);
            });
        });
    </script>

</body>
</html>
