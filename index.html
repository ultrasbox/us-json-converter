<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UltraBox JSON â†’ MIDIã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼</title>
    <style>
        body{font-family:sans-serif;padding:20px;max-width:600px;margin:0 auto;line-height:1.6;background-color:#f4f7f6}h1{color:#1a4d6f;border-bottom:3px solid #6ac4a5;padding-bottom:10px;margin-bottom:30px}.controls{background:#fff;padding:25px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08);border:1px solid #e0e0e0}label{font-weight:700;display:block;margin-bottom:8px;color:#333}input[type=file]{margin-bottom:20px;display:block;padding:10px;border:1px solid #ccc;border-radius:6px;width:95%}button{padding:12px 25px;background-color:#007bff;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:17px;transition:background-color .2s;width:100%}button:hover:not(:disabled){background-color:#0056b3}button:disabled{background-color:#a0a0a0;cursor:not-allowed}.message{margin-top:25px;padding:15px;border-radius:8px;font-weight:700;display:none;word-break:break-all}.error{background-color:#fcebeb;color:#cc0000;border:1px solid #ecc0c0}.success{background-color:#e5f6e8;color:#0a6b32;border:1px solid #b3d9c7}.warning{background-color:#fff3cd;color:#856404;border:1px solid #ffeeba}
    </style>
</head>
<body>

    <h1>UltraBox JSON â†’ MIDIã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼</h1>
    <p>JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€ä¼¸ã°ã—éŸ³ãŒåˆ‡æ–­ã•ã‚Œãªã„æ­£ç¢ºãªMIDIãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.midï¼‰ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
    
    <div class="message warning" style="display: block;">
        <strong>ã€å‹•ä½œæ¨å¥¨ç’°å¢ƒã€‘</strong> è»½é‡åŒ–ã€ãƒãƒ¼ãƒˆåˆ‡æ–­ä¿®æ­£ã€ãã—ã¦**ãƒãƒ£ãƒ³ãƒãƒ«ã”ã¨ã®ãƒˆãƒ©ãƒƒã‚¯åˆ†é›¢**ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚
        <br>â€»æ¥µç«¯ã«å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã€å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
    </div>

    <div class="controls">
        <label for="jsonFile">â‘  UltraBox JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
        <input type="file" id="jsonFile" accept=".json">

        <button id="convertButton" disabled>â‘¡ MIDIã«å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </div>

    <div id="messageArea" class="message" style="display: none;"></div>

    <script>
        const convertButton = document.getElementById('convertButton');
        const messageArea = document.getElementById('messageArea');

        function showMessage(text, type) {
            messageArea.textContent = text;
            messageArea.className = `message ${type}`;
            messageArea.style.display = 'block';
        }

        function downloadMidi(arrayBuffer, fileName) {
            const blob = new Blob([arrayBuffer], { type: "audio/midi" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName + '_fixed_multitrack.mid';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ----------------------------------------------------------------------
        // ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ (RAMè² è·ã‚¼ãƒ­, ãƒãƒ¼ãƒˆåˆ‡æ–­è§£æ¶ˆ, ãƒãƒ«ãƒãƒˆãƒ©ãƒƒã‚¯)
        // ----------------------------------------------------------------------

        // MIDIå®šæ•°ã¨VLQã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
        const MIDI_HEADER_CHUNK = 0x4D546864; 
        const MIDI_TRACK_CHUNK = 0x4D54726B; 
        const MIDI_FORMAT_MULTI_TRACK = 0x0001; // <-- Format 1ã«å¤‰æ›´
        const MIDI_NOTE_OFF = 0x80;
        const MIDI_NOTE_ON = 0x90;
        const MIDI_META = 0xFF;
        const MIDI_END_OF_TRACK = 0x2F;
        const MIDI_CHANNEL_NAME = 0x03; // ãƒ¡ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆ: ãƒˆãƒ©ãƒƒã‚¯/ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å

        const TICKS_PER_BEAT = 24; 
        const TICKS_PER_BAR = TICKS_PER_BEAT * 4; 

        function writeVariableLengthQuantity(value) {
            let buffer = [];
            if (value === 0) return [0]; 
            do {
                let byte = value & 0x7F;
                value >>= 7;
                if (value > 0) {
                    byte |= 0x80;
                }
                buffer.unshift(byte); 
            } while (value > 0);
            return buffer;
        }

        function writeUint16(value) { return [(value >> 8) & 0xFF, value & 0xFF]; }
        function writeUint32(value) { return [(value >> 24) & 0xFF, (value >> 16) & 0xFF, (value >> 8) & 0xFF, value & 0xFF]; }

        function convertUltraBoxToMidi(ultraBoxData) {
            // ğŸ’¡ å …ç‰¢æ€§ãƒã‚§ãƒƒã‚¯ã®å¼·åŒ–: channels ã¨ patterns ãŒå¿…é ˆ
            if (!ultraBoxData || !ultraBoxData.channels || !ultraBoxData.patterns) {
                throw new Error("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã«ã€æ›²ã®ãƒ‡ãƒ¼ã‚¿ (channels/patterns) ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ã‚‹ã‹ã€UltraBoxã®æ›²ãƒ‡ãƒ¼ã‚¿ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
            }
            
            const tempoBPM = ultraBoxData.tempo || 150;
            // ãƒ†ãƒ³ãƒå€¤ï¼ˆãƒã‚¤ã‚¯ãƒ­ç§’/æ‹ï¼‰
            const tempoMicrosecondsPerBeat = Math.round(60000000 / tempoBPM); 

            const trackChunks = [];
            const sequenceToLoop = ultraBoxData.sequence || []; // sequenceãŒãªãã¦ã‚‚ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãªã„ã‚ˆã†ã«ã™ã‚‹

            // 1. å„UltraBoxãƒãƒ£ãƒ³ãƒãƒ«ï¼ˆæ¥½å™¨ï¼‰ã‚’ãƒ«ãƒ¼ãƒ—ã—ã€å€‹åˆ¥ã®MIDIãƒˆãƒ©ãƒƒã‚¯ã‚’ä½œæˆ
            for (let channelIndex = 0; channelIndex < ultraBoxData.channels.length; channelIndex++) {
                const ultraBoxChannel = ultraBoxData.channels[channelIndex];
                // MIDIãƒãƒ£ãƒ³ãƒãƒ«ã¯0ã€œ15ã®ç¯„å›²ã«ãƒãƒƒãƒ—
                const midiChannel = channelIndex % 16; 

                const events = [];
                let absoluteTick = 0;
                
                // 2. ã“ã®ãƒãƒ£ãƒ³ãƒãƒ«ã®æ›²ã®é•·ã•å…¨ä½“ã‚’å·¡å›ã—ã€çµ¶å¯¾ãƒ†ã‚£ãƒƒã‚¯ã‚’è¨ˆç®—
                for (let barIndex = 0; barIndex < sequenceToLoop.length; barIndex++) {
                    
                    // UltraBox/BeepBoxã®ä¸€èˆ¬çš„ãªæ§‹é€ : ãƒãƒ£ãƒ³ãƒãƒ«ã®ãƒ‘ã‚¿ãƒ¼ãƒ³é…åˆ—ã‹ã‚‰ã€ç¾åœ¨ã®ãƒãƒ¼ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
                    const patternIndex = (ultraBoxChannel.patterns && ultraBoxChannel.patterns[barIndex] !== undefined)
                        ? ultraBoxChannel.patterns[barIndex]
                        : -1; 
                    
                    if (patternIndex !== -1 && ultraBoxData.patterns[patternIndex] && ultraBoxData.patterns[patternIndex].notes) {
                        const pattern = ultraBoxData.patterns[patternIndex];
                        
                        // ãƒãƒ¼ãƒˆåˆ‡æ–­è§£æ¶ˆã®ãŸã‚ã® Note On/Off ã‚¤ãƒ™ãƒ³ãƒˆåˆ†é›¢
                        for (const note of pattern.notes) {
                            
                            // Note On ã‚¤ãƒ™ãƒ³ãƒˆ
                            events.push({
                                tick: absoluteTick + note.start, 
                                type: MIDI_NOTE_ON,
                                pitch: note.pitch,
                                velocity: Math.round((note.volume + 1) * 127 / 10), 
                                channel: midiChannel 
                            });
                            
                            // Note Off ã‚¤ãƒ™ãƒ³ãƒˆ (æ­£ç¢ºãªçµ¶å¯¾çµ‚äº†æ™‚åˆ»)
                            events.push({
                                tick: absoluteTick + note.start + note.duration, 
                                type: MIDI_NOTE_OFF,
                                pitch: note.pitch,
                                velocity: 0, 
                                channel: midiChannel 
                            });
                        }
                    }
                    absoluteTick += TICKS_PER_BAR; // æ¬¡ã®ãƒãƒ¼ã®é–‹å§‹ãƒ†ã‚£ãƒƒã‚¯
                }

                // 3. ã‚¤ãƒ™ãƒ³ãƒˆã‚’çµ¶å¯¾ãƒ†ã‚£ãƒƒã‚¯é †ã«ã‚½ãƒ¼ãƒˆ
                events.sort((a, b) => a.tick - b.tick);
                
                // 4. MIDIãƒˆãƒ©ãƒƒã‚¯ãƒãƒ£ãƒ³ã‚¯ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰
                const trackEvents = [];
                let lastTick = 0;

                // ãƒãƒ£ãƒ³ãƒãƒ«åã‚’è¿½åŠ  (ãƒˆãƒ©ãƒƒã‚¯å)
                const channelName = ultraBoxChannel.name || `Track ${channelIndex + 1}`;
                const nameBytes = Array.from(new TextEncoder().encode(channelName));

                trackEvents.push(
                    ...writeVariableLengthQuantity(0), MIDI_META, MIDI_CHANNEL_NAME, 
                    ...writeVariableLengthQuantity(nameBytes.length), 
                    ...nameBytes
                );
                
                // ãƒãƒ¼ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã®æ›¸ãè¾¼ã¿
                for (const event of events) {
                    const deltaTime = event.tick - lastTick;
                    if (deltaTime < 0) throw new Error("MIDI Time Error: Negative delta time.");

                    trackEvents.push(
                        ...writeVariableLengthQuantity(deltaTime), 
                        event.type | event.channel, 
                        event.pitch[0], // ãƒ”ãƒƒãƒ
                        event.velocity 
                    );

                    lastTick = event.tick;
                }

                // ãƒˆãƒ©ãƒƒã‚¯çµ‚ç«¯ã‚¤ãƒ™ãƒ³ãƒˆ
                trackEvents.push(
                    ...writeVariableLengthQuantity(0), MIDI_META, MIDI_END_OF_TRACK, 0x00 
                );
                
                // æœ€çµ‚çš„ãªãƒˆãƒ©ãƒƒã‚¯ãƒãƒ£ãƒ³ã‚¯æ§‹é€ 
                const trackSize = trackEvents.length;
                const trackChunk = [
                    ...writeUint32(MIDI_TRACK_CHUNK), 
                    ...writeUint32(trackSize), 
                    ...trackEvents
                ];
                trackChunks.push(trackChunk);
            }
            
            // 5. ãƒ†ãƒ³ãƒãƒˆãƒ©ãƒƒã‚¯ï¼ˆæœ€åˆã®ãƒˆãƒ©ãƒƒã‚¯ï¼‰ã‚’ä½œæˆ
            const tempoTrackEvents = [];
            // ãƒ†ãƒ³ãƒè¨­å®š
            tempoTrackEvents.push(
                ...writeVariableLengthQuantity(0), MIDI_META, 0x51, 0x03, 
                ...writeUint32(tempoMicrosecondsPerBeat).slice(1) 
            );
            // ãƒˆãƒ©ãƒƒã‚¯çµ‚ç«¯
            tempoTrackEvents.push(
                ...writeVariableLengthQuantity(0), MIDI_META, MIDI_END_OF_TRACK, 0x00 
            );
            
            const tempoTrackChunk = [
                ...writeUint32(MIDI_TRACK_CHUNK), 
                ...writeUint32(tempoTrackEvents.length), 
                ...tempoTrackEvents
            ];

            // 6. ãƒ˜ãƒƒãƒ€ãƒ¼ã¨å…¨ãƒˆãƒ©ãƒƒã‚¯ãƒãƒ£ãƒ³ã‚¯ã‚’çµåˆ
            const totalTracks = trackChunks.length + 1; // ãƒ†ãƒ³ãƒãƒˆãƒ©ãƒƒã‚¯ + æ¥½å™¨ãƒˆãƒ©ãƒƒã‚¯
            const header = [
                ...writeUint32(MIDI_HEADER_CHUNK), ...writeUint32(6), 
                ...writeUint16(MIDI_FORMAT_MULTI_TRACK), // Format 1
                ...writeUint16(totalTracks), 
                ...writeUint16(TICKS_PER_BEAT) 
            ];

            // ãƒ†ãƒ³ãƒãƒˆãƒ©ãƒƒã‚¯ã‚’æœ€åˆã«è¿½åŠ ã—ã€ãã®å¾Œã«æ¥½å™¨ãƒˆãƒ©ãƒƒã‚¯ã‚’è¿½åŠ 
            const fullMidi = [...header, ...tempoTrackChunk];
            trackChunks.forEach(chunk => fullMidi.push(...chunk));

            return new Uint8Array(fullMidi).buffer;
        }

        // ----------------------------------------------------------------------
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ (çœç•¥)
        // ----------------------------------------------------------------------
        
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('jsonFile');
            
            showMessage('âœ… å¤‰æ›æ©Ÿèƒ½ã®æº–å‚™å®Œäº†ã€‚JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'success');

            fileInput.addEventListener('change', (e) => {
                showMessage('', 'none');
                convertButton.disabled = true;
                const file = e.target.files[0];
                
                if (!file) return;

                showMessage(`ğŸ” ãƒ•ã‚¡ã‚¤ãƒ« [${file.name}] ã®èª­ã¿è¾¼ã¿ã‚’é–‹å§‹ã—ã¾ã—ãŸ...`, 'success'); 

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const ultraBoxData = JSON.parse(event.target.result);
                        
                        // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
                        if (ultraBoxData && (ultraBoxData.format === "UltraBox" || ultraBoxData.format === "BeepBox")) {
                            // channelsã¨patternsã®åŸºæœ¬çš„ãªå­˜åœ¨ãƒã‚§ãƒƒã‚¯
                            if (!ultraBoxData.channels || !ultraBoxData.patterns) {
                                throw new Error("UltraBoxãƒ•ã‚¡ã‚¤ãƒ«ã«å¿…è¦ãªãƒãƒ£ãƒ³ãƒãƒ«ã¾ãŸã¯ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                            }
                            
                            convertButton.ultraBoxData = ultraBoxData;
                            convertButton.fileName = file.name.replace(/\.json$/i, ''); 
                            convertButton.disabled = false;
                            showMessage(`âœ… ã€Œ${file.name}ã€ã®èª­ã¿è¾¼ã¿ã«æˆåŠŸã—ã¾ã—ãŸã€‚å¤‰æ›ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`, 'success');
                        } else {
                            throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒUltraBox/BeepBoxã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`);
                        }
                    } catch (error) {
                        showMessage(`âŒ ãƒ•ã‚¡ã‚¤ãƒ«è§£æå¤±æ•—: ${error.message}`, 'error');
                        convertButton.ultraBoxData = null;
                    }
                };
                
                reader.readAsText(file);
            });

            convertButton.addEventListener('click', () => {
                if (!convertButton.ultraBoxData) return showMessage('âŒ å¤‰æ›ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');

                convertButton.disabled = true;
                showMessage('ğŸ”„ MIDIã¸ã®å¤‰æ›ã‚’é–‹å§‹ã—ã¾ã—ãŸ...', 'success');
                
                try {
                    const arrayBuffer = convertUltraBoxToMidi(convertButton.ultraBoxData);
                    
                    downloadMidi(arrayBuffer, convertButton.fileName);
                    
                    showMessage('ğŸ‰ MIDIãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼', 'success');
                    convertButton.disabled = false;

                } catch (error) {
                    showMessage(`ğŸ’¥ å¤‰æ›å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'error');
                    convertButton.disabled = false;
                }
            });
        });
    </script>

</body>
</html>
