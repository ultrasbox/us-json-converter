<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UltraBox JSON â†’ MIDIã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ (Workerç‰ˆ)</title>
    <style>
        body{font-family:sans-serif;padding:20px;max-width:600px;margin:0 auto;line-height:1.6;background-color:#f4f7f6}h1{color:#1a4d6f;border-bottom:3px solid #6ac4a5;padding-bottom:10px;margin-bottom:30px}.controls{background:#fff;padding:25px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08);border:1px solid #e0e0e0}label{font-weight:700;display:block;margin-bottom:8px;color:#333}input[type=file]{margin-bottom:20px;display:block;padding:10px;border:1px solid #ccc;border-radius:6px;width:95%}button{padding:12px 25px;background-color:#007bff;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:17px;transition:background-color .2s;width:100%}button:hover:not(:disabled){background-color:#0056b3}button:disabled{background-color:#a0a0a0;cursor:not-allowed}.message{margin-top:25px;padding:15px;border-radius:8px;font-weight:700;display:none;word-break:break-all}.error{background-color:#fcebeb;color:#cc0000;border:1px solid #ecc0c0}.success{background-color:#e5f6e8;color:#0a6b32;border:1px solid #b3d9c7}.warning{background-color:#fff3cd;color:#856404;border:1px solid #ffeeba}
    </style>
</head>
<body>

    <h1>UltraBox JSON â†’ MIDIã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼</h1>
    <p>JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€ä¼¸ã°ã—éŸ³ãŒåˆ‡æ–­ã•ã‚Œãªã„æ­£ç¢ºãªMIDIãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.midï¼‰ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
    <div class="message warning" style="display: block;">
        <strong>æ¨å¥¨ç’°å¢ƒ:</strong> iPad Proã€PCã€é«˜æ€§èƒ½ãªAndroidç«¯æœ«ã€‚<br>
        æ—§ä¸–ä»£iPadã§ã¯ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
    </div>

    <div class="controls">
        <label for="jsonFile">â‘  UltraBox JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
        <input type="file" id="jsonFile" accept=".json">

        <button id="convertButton" disabled>â‘¡ MIDIã«å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </div>

    <div id="messageArea" class="message" style="display: none;"></div>

    <script>
        let midiWorker;
        let coreLoaded = false;
        const convertButton = document.getElementById('convertButton');
        const messageArea = document.getElementById('messageArea');

        function showMessage(text, type) {
            messageArea.textContent = text;
            messageArea.className = `message ${type}`;
            messageArea.style.display = 'block';
        }

        function downloadMidi(arrayBuffer, fileName) {
            const blob = new Blob([arrayBuffer], { type: "audio/midi" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName + '_fixed.mid';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Web Workerã‚’èµ·å‹•ã—ã€é€šä¿¡ã‚’è¨­å®šã™ã‚‹
        function initWorker() {
            if (typeof Worker === 'undefined') {
                return showMessage('âŒ ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Web Workersã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚', 'error');
            }

            showMessage('ğŸ”„ å¤‰æ›æ©Ÿèƒ½ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ãƒ­ãƒ¼ãƒ‰ä¸­ã§ã™...', 'success');

            try {
                // Workerãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¦èµ·å‹•
                midiWorker = new Worker('midi-worker.js');

                // Workerã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†
                midiWorker.onmessage = function(e) {
                    const { status, message, arrayBuffer, fileName } = e.data;
                    
                    if (status === 'ready') {
                        // ã‚³ã‚¢ã‚³ãƒ¼ãƒ‰ã®ãƒ­ãƒ¼ãƒ‰å®Œäº†é€šçŸ¥
                        coreLoaded = true;
                        showMessage('âœ… å¤‰æ›æ©Ÿèƒ½ã®æº–å‚™å®Œäº†ã€‚JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'success');
                    } else if (status === 'complete') {
                        // å¤‰æ›å®Œäº†é€šçŸ¥ï¼ˆæœ€ã‚‚é‡ã„å‡¦ç†ãŒå®Œäº†ï¼‰
                        downloadMidi(arrayBuffer, fileName);
                        showMessage('ğŸ‰ MIDIãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼', 'success');
                        convertButton.disabled = false;
                    } else if (status === 'error') {
                        // Workerå†…ã®ã‚¨ãƒ©ãƒ¼ã‚’å ±å‘Š
                        showMessage(`ğŸ’¥ å¤‰æ›å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${message}`, 'error');
                        convertButton.disabled = false;
                    }
                };

                // WorkerãŒã‚¨ãƒ©ãƒ¼ã‚’å ±å‘Šã—ãŸã¨ãã®å‡¦ç†ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿å¤±æ•—ãªã©ï¼‰
                midiWorker.onerror = function(e) {
                    showMessage(`ğŸ’£ Web Workerã‚¨ãƒ©ãƒ¼: ${e.message}. ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`, 'error');
                    console.error("Worker Error:", e);
                    convertButton.disabled = true;
                };

            } catch (e) {
                showMessage(`âŒ Web Workerã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`, 'error');
                console.error("Worker Init Error:", e);
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('jsonFile');
            //initWorker(); // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰ç›´å¾Œã«Workerã‚’èµ·å‹•

            fileInput.addEventListener('change', (e) => {
                showMessage('', 'none');
                convertButton.disabled = true;
                const file = e.target.files[0];
                
                if (!file) return;

                if (!coreLoaded) return showMessage('ğŸ”„ å¤‰æ›æ©Ÿèƒ½ãŒã¾ã æº–å‚™ä¸­ã§ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');

                showMessage(`ğŸ” ãƒ•ã‚¡ã‚¤ãƒ« [${file.name}] ã®èª­ã¿è¾¼ã¿ã‚’é–‹å§‹ã—ã¾ã—ãŸ...`, 'success'); 

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const ultraBoxData = JSON.parse(event.target.result);
                        
                        if (ultraBoxData && (ultraBoxData.format === "UltraBox" || ultraBoxData.format === "BeepBox")) {
                            convertButton.ultraBoxData = ultraBoxData;
                            convertButton.fileName = file.name.replace(/\.json$/i, ''); // æ‹¡å¼µå­é™¤å»
                            convertButton.disabled = false;
                            showMessage(`âœ… ã€Œ${file.name}ã€ã®èª­ã¿è¾¼ã¿ã«æˆåŠŸã—ã¾ã—ãŸã€‚å¤‰æ›ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`, 'success');
                        } else {
                            throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒUltraBox/BeepBoxã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`);
                        }
                    } catch (error) {
                        showMessage(`âŒ ãƒ•ã‚¡ã‚¤ãƒ«è§£æå¤±æ•—: ${error.message}`, 'error');
                        convertButton.ultraBoxData = null;
                    }
                };
                
                reader.readAsText(file);
            });
setTimeout(initWorker, 100);
            convertButton.addEventListener('click', () => {
                if (!coreLoaded || !convertButton.ultraBoxData) return showMessage('âŒ å¤‰æ›æ©Ÿèƒ½ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');

                convertButton.disabled = true;
                showMessage('ğŸ”„ MIDIã¸ã®å¤‰æ›ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§é–‹å§‹ã—ã¾ã—ãŸ...', 'success');
                
                // Workerã«ã‚³ãƒãƒ³ãƒ‰ã¨ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
                midiWorker.postMessage({
                    command: 'convert',
                    data: convertButton.ultraBoxData,
                    fileName: convertButton.fileName
                });
            });
        });
    </script>
</body>
</html>
