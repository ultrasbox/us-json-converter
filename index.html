<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UltraBox JSON â†’ MIDIã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ (v57.0 - ãƒ”ãƒƒãƒãƒ™ãƒ³ãƒ‰ãƒ¬ãƒ³ã‚¸ä¿®æ­£)</title>
    <style>
        body{font-family:sans-serif;padding:20px;max-width:800px;margin:0 auto;line-height:1.6;background-color:#f4f7f6}h1{color:#1a4d6f;border-bottom:3px solid #6ac4a5;padding-bottom:10px;margin-bottom:30px}.controls{background:#fff;padding:25px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08);border:1px solid #e0e0e0}label{font-weight:700;display:block;margin-bottom:8px;color:#333}input[type=file]{margin-bottom:20px;display:block;padding:10px;border:1px solid #ccc;border-radius:6px;width:95%}button{padding:12px 25px;background-color:#007bff;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:17px;transition:background-color .2s;width:100%;margin-top:10px;}button:hover:not(:disabled){background-color:#0056b3}button:disabled{background-color:#a0a0a0;cursor:not-allowed}.message{margin-top:25px;padding:15px;border-radius:8px;font-weight:700;display:block;word-break:break-all}.error{background-color:#fcebeb;color:#cc0000;border:1px solid #ecc0c0}.success{background-color:#e5f6e8;color:#0a6b32;border:1px solid #b3d9c7}.warning{background-color:#fff3cd;color:#856404;border:1px solid #ffeeba}#logDownloadContainer{margin-top:15px;}.log-button{background-color:#6ac4a5;color:white;border:none;font-weight:700;}.log-button:hover{background-color:#4ca388;}
        #logDisplay {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
            max-height: 400px; 
            overflow-y: scroll;
        }
    </style>
</head>
<body>

    <h1>UltraBox JSON â†’ MIDIã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ (v57.0 - ãƒ”ãƒƒãƒãƒ™ãƒ³ãƒ‰ãƒ¬ãƒ³ã‚¸ä¿®æ­£)</h1>
    <p>JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€æ­£ç¢ºãªMIDIãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.midï¼‰ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
    
    <div class="message warning" style="display: block;">
        <strong>ã€éŸ³è³ªæ”¹å–„ v57.0ã€‘</strong> ã€Œmp3-to-MIDIã®ã‚ˆã†ãªéŸ³ã€å¯¾ç­–ã¨ã—ã¦ã€**MIDIãƒ•ã‚¡ã‚¤ãƒ«å†…ã§ãƒ”ãƒƒãƒãƒ™ãƒ³ãƒ‰ã®å¯å‹•ç¯„å›²ã‚’1ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ï¼ˆÂ±12åŠéŸ³ï¼‰ã«è¨­å®š**ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚éŸ³ãŒæ”¹å–„ã•ã‚Œã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
    </div>

    <div class="controls">
        <label for="jsonFile">â‘  UltraBox JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
        <input type="file" id="jsonFile" accept=".json">

        <button id="convertButton" disabled>â‘¡ MIDIã«å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </div>

    <div id="messageArea" class="message" style="display: none;"></div>
    
    <div id="logDownloadContainer"></div>

    <h2>å¤‰æ›ãƒ­ã‚°å‡ºåŠ›</h2>
    <pre id="logDisplay">ã“ã“ã«å¤‰æ›ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</pre>

    <script>
        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³å®šæ•°ã‚’å®šç¾©
        const CONVERTER_VERSION = "v57.0 (Format 0 - ãƒ”ãƒƒãƒãƒ™ãƒ³ãƒ‰ãƒ¬ãƒ³ã‚¸ä¿®æ­£)";
        const MAX_DETAIL_LOG_NOTES = 200; 

        const convertButton = document.getElementById('convertButton');
        const messageArea = document.getElementById('messageArea');
        const logDownloadContainer = document.getElementById('logDownloadContainer');
        const logDisplay = document.getElementById('logDisplay');
        let logContentToDownload = null;
        let logFileName = null;


        function showMessage(text, type) {
            messageArea.innerHTML = `<span>${text}</span>`;
            messageArea.className = `message ${type}`;
            messageArea.style.display = 'block';
        }
        
        function updateLogDisplay(content) {
            logDisplay.textContent = content;
            logDisplay.scrollTop = logDisplay.scrollHeight; 
        }

        function downloadFile(content, fileName, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function displayLogButton(logContent, baseFileName, isError = false) {
            logFileName = baseFileName + (isError ? '_ERROR_log.txt' : '_log.txt');
            logContentToDownload = logContent;
            
            updateLogDisplay(logContent); 

            logDownloadContainer.innerHTML = `
                <button id="logDownloadButton" class="log-button">
                    ${isError ? 'ğŸ’¥ ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«' : 'âœ… ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«'} (${logFileName}) ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
            `;
            document.getElementById('logDownloadButton').addEventListener('click', () => {
                downloadFile(logContentToDownload, logFileName, "text/plain");
            });
        }

        // ----------------------------------------------------------------------
        // ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ (v57.0 - MIDIå½¢å¼0)
        // ----------------------------------------------------------------------

        const MIDI_TICKS_PER_BEAT = 24; 
        const MIDI_HEADER_CHUNK = 0x4D546864; 
        const MIDI_TRACK_CHUNK = 0x4D54726B; 
        const MIDI_FORMAT_SINGLE_TRACK = 0x0000; // å½¢å¼0
        const MIDI_NOTE_ON = 0x90;
        const MIDI_NOTE_OFF = 0x80;
        const MIDI_PROGRAM_CHANGE = 0xC0; 
        const MIDI_CONTROL_CHANGE = 0xB0; 
        const MIDI_PITCH_BEND_CHANGE = 0xE0; 
        const MIDI_META = 0xFF;
        const MIDI_END_OF_TRACK = 0x2F;
        const MIDI_CHANNEL_NAME = 0x03; 
        const MIDI_SET_TEMPO = 0x51; 
        const CC_VOLUME = 0x07; 
        const PITCH_BEND_RESET_LSB = 0x00; 
        const PITCH_BEND_RESET_MSB = 0x40; 
        
        // --- v57.0 NEW: ãƒ”ãƒƒãƒãƒ™ãƒ³ãƒ‰ãƒ¬ãƒ³ã‚¸è¨­å®šç”¨å®šæ•° ---
        const CC_RPN_MSB = 0x65; // RPN MSB (101)
        const CC_RPN_LSB = 0x64; // RPN LSB (100)
        const CC_DATA_ENTRY_MSB = 0x06; // Data Entry MSB (6)
        const CC_DATA_ENTRY_LSB = 0x26; // Data Entry LSB (38)
        const PITCH_BEND_RANGE_SEMITONES = 12; // 1ã‚ªã‚¯ã‚¿ãƒ¼ãƒ– = 12åŠéŸ³

        function writeVariableLengthQuantity(value) {
            let buffer = [];
            if (value === 0) return [0]; 
            do {
                let byte = value & 0x7F;
                value >>= 7;
                if (value > 0) {
                    byte |= 0x80;
                }
                buffer.unshift(byte); 
            } while (value > 0);
            return buffer;
        }

        function writeUint16(value) { return [(value >> 8) & 0xFF, value & 0xFF]; }
        function writeUint32(value) { return [(value >> 24) & 0xFF, (value >> 16) & 0xFF, (value >> 8) & 0xFF, value & 0xFF]; }
        
        function convertPitchBend(ultraBoxValue) {
            const clampedValue = Math.min(1.0, Math.max(-1.0, ultraBoxValue));
            const midiValue = Math.round((clampedValue + 1.0) * 8191.5); 
            const lsb = midiValue & 0x7F; 
            const msb = (midiValue >> 7) & 0x7F; 
            return [lsb, msb];
        }

        function getPatternFromReference(rawPatternRef, channelPatterns, globalPatterns) {
            
            const diagnosticInfo = {
                type: typeof rawPatternRef,
                value: rawPatternRef,
                keys: null,
                searchOrder: []
            };

            if (rawPatternRef === null || rawPatternRef === undefined) {
                diagnosticInfo.status = "Failed: Null/Undefined Reference";
                return { pattern: null, diagnosticInfo };
            }

            if (diagnosticInfo.type === 'object' && rawPatternRef !== null) {
                diagnosticInfo.keys = Object.keys(rawPatternRef).join(', ') || 'N/A';
            }

            // 1. Direct Object Embedding Check (éŸ³ç¬¦ãƒ‡ãƒ¼ã‚¿ãŒç›´æ¥å…¥ã£ã¦ã„ã‚‹å ´åˆ)
            if (diagnosticInfo.type === 'object' && rawPatternRef !== null && Array.isArray(rawPatternRef.notes)) {
                diagnosticInfo.status = "Success: Direct Object Embedding";
                return { pattern: rawPatternRef, diagnosticInfo }; 
            }
            
            let patternIndex = -1;
            // 2. IDæŠ½å‡º
            if (diagnosticInfo.type === 'number' && rawPatternRef >= 0 && Number.isInteger(rawPatternRef)) {
                patternIndex = rawPatternRef; 
            } else if (diagnosticInfo.type === 'object' && rawPatternRef !== null) {
                if (typeof rawPatternRef.pattern === 'number' && rawPatternRef.pattern >= 0) {
                    patternIndex = rawPatternRef.pattern; 
                } else if (typeof rawPatternRef.patternId === 'number' && rawPatternRef.patternId >= 0) {
                    patternIndex = rawPatternRef.patternId;
                } else if (typeof rawPatternRef.id === 'number' && rawPatternRef.id >= 0) {
                    patternIndex = rawPatternRef.id;
                }
            }
            
            if (patternIndex >= 0) {
                
                // 3. Channel Patternsæ¤œç´¢
                if (channelPatterns) {
                    diagnosticInfo.searchOrder.push(`Channel Patterns (ID: ${patternIndex})`);
                    let pattern = null;
                    if (Array.isArray(channelPatterns)) {
                        pattern = channelPatterns[patternIndex];
                    } else if (typeof channelPatterns === 'object') {
                        pattern = channelPatterns[String(patternIndex)];
                    }
                    if (pattern && Array.isArray(pattern.notes)) {
                        diagnosticInfo.status = "Success: Channel Pattern";
                        return { pattern, diagnosticInfo };
                    }
                }

                // 4. Global Patternsæ¤œç´¢
                if (globalPatterns) {
                    diagnosticInfo.searchOrder.push(`Global Patterns (ID: ${patternIndex})`);
                    let pattern = null;
                    if (Array.isArray(globalPatterns)) {
                        pattern = globalPatterns[patternIndex];
                    } else if (typeof globalPatterns === 'object') {
                        pattern = globalPatterns[String(patternIndex)];
                    }
                    if (pattern && Array.isArray(pattern.notes)) {
                        diagnosticInfo.status = "Success: Global Pattern";
                        return { pattern, diagnosticInfo };
                    }
                }
                
                diagnosticInfo.status = `Failed: ID ${patternIndex} found, but pattern data (with notes:[]) was missing in all sources.`;

            } else {
                diagnosticInfo.status = "Failed: Could not extract valid pattern ID.";
            }
            
            return { pattern: null, diagnosticInfo }; 
        }
        
        function convertUltraBoxToMidi(ultraBoxData) {
            if (!ultraBoxData) {
                throw new Error("JSONãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚");
            }
            
            const channels = Array.isArray(ultraBoxData.channels) 
                ? ultraBoxData.channels 
                : Object.values(ultraBoxData.channels || {}); 
            
            if (channels.length === 0) {
                 throw new Error("ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚¨ãƒ©ãƒ¼: ãƒãƒ£ãƒ³ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ ('channels') ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€ç©ºã§ã™ã€‚");
            }
            
            const globalPatterns = ultraBoxData.patterns || {}; 
            
            let sequenceToLoop = ultraBoxData.sequence || []; 
            
            if (sequenceToLoop.length === 0) {
                const firstChannelPatterns = channels[0]?.patterns;
                if (firstChannelPatterns && Array.isArray(firstChannelPatterns) && firstChannelPatterns.length > 0) {
                    sequenceToLoop = firstChannelPatterns.map((_, i) => i); 
                }
            }
            
            if (sequenceToLoop.length === 0) {
                 throw new Error("ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚¨ãƒ©ãƒ¼: ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ ('sequence') ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€ç©ºã§ã™ã€‚");
            }
            
            const totalBars = Math.min(sequenceToLoop.length, ultraBoxData.loopBars || sequenceToLoop.length);
            sequenceToLoop = sequenceToLoop.slice(0, totalBars); 
            
            const tempoBPM = ultraBoxData.beatsPerMinute || 150;
            const tempoMicrosecondsPerBeat = Math.round(60000000 / tempoBPM); 
            
            const ultraBoxTicksPerBeat = ultraBoxData.ticksPerBeat || 4; 
            const beatsPerBar = ultraBoxData.beatsPerBar || 4;
            const midiTicksPerBar = MIDI_TICKS_PER_BEAT * beatsPerBar; 
            
            const tickScaleFactor = MIDI_TICKS_PER_BEAT / ultraBoxTicksPerBeat; 

            let allEvents = []; // å…¨ãƒˆãƒ©ãƒƒã‚¯ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã“ã“ã«é›†ç´„
            let noteCount = 0; 
            let skippedEvents = []; 
            let processedNotesLog = []; 

            let logDetailsSummary = [
                `ã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${CONVERTER_VERSION}`,
                `--- å¤‰æ›ã‚µãƒãƒªãƒ¼ ---`,
                `UltraBoxãƒãƒ£ãƒ³ãƒãƒ«æ•°: ${channels.length}å€‹`,
                `MIDIå½¢å¼: Format 0 (ã‚·ãƒ³ã‚°ãƒ«ãƒ»ãƒˆãƒ©ãƒƒã‚¯)`,
                `å°ç¯€ãƒ«ãƒ¼ãƒ—æ•° (å‡¦ç†å¯¾è±¡): ${totalBars}å›`,
                `1å°ç¯€ã‚ãŸã‚Šã® MIDIãƒ†ã‚£ãƒƒã‚¯: ${midiTicksPerBar}t (å…ƒã®ãƒ†ã‚£ãƒƒã‚¯: ${ultraBoxTicksPerBar * beatsPerBar}t)`,
                `MIDIãƒ†ã‚£ãƒƒã‚¯å¤‰æ›æ¯”ç‡: ${tickScaleFactor}å€`,
                `ãƒ”ãƒƒãƒãƒ™ãƒ³ãƒ‰ãƒ¬ãƒ³ã‚¸è¨­å®š: ${PITCH_BEND_RANGE_SEMITONES}åŠéŸ³ (v57.0è¿½åŠ )`
            ].join('\n');


            // 1. ãƒ†ãƒ³ãƒã‚¤ãƒ™ãƒ³ãƒˆã®è¿½åŠ 
            allEvents.push({ 
                tick: 0, 
                type: MIDI_META, 
                metaType: MIDI_SET_TEMPO, 
                data: writeUint32(tempoMicrosecondsPerBeat).slice(1) // 3 bytes
            });

            // 2. ãƒãƒ£ãƒ³ãƒãƒ«ã”ã¨ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’åé›†
            for (let channelIndex = 0; channelIndex < channels.length; channelIndex++) {
                const ultraBoxChannel = channels[channelIndex];
                const midiChannel = channelIndex % 16; 
                
                const channelPatterns = ultraBoxChannel.patterns; 

                const ultraBoxPresetId = ultraBoxChannel.instruments?.[0]?.preset;
                const gmProgramNumber = (ultraBoxPresetId !== undefined && ultraBoxPresetId >= 0 && ultraBoxPresetId < 128) ? ultraBoxPresetId : 0; 
                
                const instrumentType = ultraBoxChannel.instruments?.[0]?.type;
                const channelName = ultraBoxChannel.name || instrumentType || `Track ${channelIndex + 1}`;
                
                // ãƒˆãƒ©ãƒƒã‚¯åã‚¤ãƒ™ãƒ³ãƒˆ (Format 0ã§ã¯ãƒˆãƒ©ãƒƒã‚¯åã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹)
                 allEvents.push({ 
                    tick: 0, 
                    type: MIDI_META, 
                    metaType: MIDI_CHANNEL_NAME, 
                    data: Array.from(new TextEncoder().encode(channelName)),
                    channel: midiChannel 
                });

                // ãƒˆãƒ©ãƒƒã‚¯åˆæœŸåŒ–ã‚¤ãƒ™ãƒ³ãƒˆ (tick 0)
                
                // a. ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒã‚§ãƒ³ã‚¸ (æ¥½å™¨é¸æŠ)
                allEvents.push({ tick: 0, type: MIDI_PROGRAM_CHANGE, value1: gmProgramNumber, channel: midiChannel });
                // b. ãƒãƒ£ãƒ³ãƒãƒ«ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’æœ€å¤§ã«è¨­å®š (CC#7)
                allEvents.push({ tick: 0, type: MIDI_CONTROL_CHANGE, value1: CC_VOLUME, value2: 127, channel: midiChannel });
                
                // c. ãƒ”ãƒƒãƒãƒ™ãƒ³ãƒ‰ãƒ»ãƒ¬ãƒ³ã‚¸ã®è¨­å®š (RPN) <- v57.0 NEW
                // RPNã‚’Pitch Bend Range (00/00)ã«è¨­å®š
                allEvents.push({ tick: 0, type: MIDI_CONTROL_CHANGE, value1: CC_RPN_MSB, value2: 0x00, channel: midiChannel });
                allEvents.push({ tick: 0, type: MIDI_CONTROL_CHANGE, value1: CC_RPN_LSB, value2: 0x00, channel: midiChannel });
                // Data Entry MSBã§ãƒ¬ãƒ³ã‚¸(åŠéŸ³)ã‚’è¨­å®š (12 semitones)
                allEvents.push({ tick: 0, type: MIDI_CONTROL_CHANGE, value1: CC_DATA_ENTRY_MSB, value2: PITCH_BEND_RANGE_SEMITONES, channel: midiChannel });
                // Data Entry LSBã¯é€šå¸¸0
                allEvents.push({ tick: 0, type: MIDI_CONTROL_CHANGE, value1: CC_DATA_ENTRY_LSB, value2: 0x00, channel: midiChannel });
                
                // d. ãƒ”ãƒƒãƒãƒ™ãƒ³ãƒ‰ãƒªã‚»ãƒƒãƒˆ
                allEvents.push({ tick: 0, type: MIDI_PITCH_BEND_CHANGE, value1: PITCH_BEND_RESET_LSB, value2: PITCH_BEND_RESET_MSB, channel: midiChannel });


                let absoluteBarStartTick = 0; 

                // 3. ãƒ‘ã‚¿ãƒ¼ãƒ³å†…ã®ãƒãƒ¼ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã‚’åé›†
                for (let barIndex = 0; barIndex < totalBars; barIndex++) {
                    
                    const rawPatternRef = sequenceToLoop[barIndex]; 
                    const { pattern, diagnosticInfo } = getPatternFromReference(rawPatternRef, channelPatterns, globalPatterns);

                    if (pattern && Array.isArray(pattern.notes)) {
                        
                        const patternNotes = pattern.notes; 

                        if (patternNotes.length > 0) {
                            
                            for (let noteIndex = 0; noteIndex < patternNotes.length; noteIndex++) {
                                const note = patternNotes[noteIndex];
                                
                                const continuesLast = note.continuesLastPattern === true; 

                                const pitches = (Array.isArray(note.pitches) && note.pitches.length > 0) 
                                    ? note.pitches 
                                    : (Array.isArray(note.pitch) ? note.pitch : [note.pitch]); 
                                
                                if (!pitches || pitches.length === 0) {
                                    skippedEvents.push(`[Ch${channelIndex+1} Bar${barIndex+1}, Note${noteIndex}] ç†ç”±: éŸ³é«˜ãƒ‡ãƒ¼ã‚¿(pitches/pitch)ãŒè¦‹ã¤ã‹ã‚‰ãªã„`);
                                    continue;
                                }

                                let ultraBoxStart = note.start;
                                let pointsValid = note.points && Array.isArray(note.points) && note.points.length > 0;
                                
                                if ((ultraBoxStart === undefined || ultraBoxStart === null) && pointsValid && typeof note.points[0].tick === 'number') {
                                    ultraBoxStart = note.points[0].tick;
                                }

                                let ultraBoxDuration = 0;
                                if (typeof note.duration === 'number' && note.duration > 0) {
                                    ultraBoxDuration = note.duration;
                                } else if (pointsValid) {
                                    const lastPoint = note.points[note.points.length - 1];
                                    if (typeof lastPoint.tick === 'number') {
                                        ultraBoxDuration = lastPoint.tick;
                                    }
                                }
                                
                                if (ultraBoxStart === undefined || typeof ultraBoxStart !== 'number' || ultraBoxDuration <= 0) {
                                    let reason = `é–‹å§‹ãƒ†ã‚£ãƒƒã‚¯: ${ultraBoxStart} (${typeof ultraBoxStart}), æŒç¶šæ™‚é–“: ${ultraBoxDuration}`;
                                    skippedEvents.push(`[Ch${channelIndex+1} Bar${barIndex+1}, Note${noteIndex}] ç†ç”±: é–‹å§‹ä½ç½®ã¾ãŸã¯æŒç¶šæ™‚é–“ãŒä¸æ­£ (${reason})`);
                                    continue;
                                }

                                const midiStart = Math.round(ultraBoxStart * tickScaleFactor);
                                const midiDuration = Math.round(ultraBoxDuration * tickScaleFactor); 

                                if (midiDuration <= 0) {
                                    skippedEvents.push(`[Ch${channelIndex+1} Bar${barIndex+1}, Note${noteIndex}] ç†ç”±: MIDIæŒç¶šæ™‚é–“(${midiDuration}t)ãŒ0ä»¥ä¸‹`);
                                    continue;
                                }
                                
                                const noteOnTick = absoluteBarStartTick + midiStart;
                                const noteOffTick = noteOnTick + midiDuration; 

                                // V54.0ä»¥é™: ãƒ™ãƒ­ã‚·ãƒ†ã‚£ã‚’å¼·åˆ¶çš„ã«æœ€å¤§ (127) ã«è¨­å®š
                                let velocity = 127; 


                                for (const pitchValue of pitches) {
                                    
                                    if (typeof pitchValue !== 'number' || pitchValue < 0 || pitchValue > 127) {
                                        skippedEvents.push(`[Ch${channelIndex+1} Bar${barIndex+1}, Note${noteIndex}] ç†ç”±: éŸ³é«˜(${pitchValue})ãŒMIDIç¯„å›²å¤–`);
                                        continue;
                                    }
                                    
                                    if (!continuesLast) { 
                                        allEvents.push({
                                            tick: noteOnTick, 
                                            type: MIDI_NOTE_ON, 
                                            pitch: pitchValue, 
                                            velocity: velocity, 
                                            channel: midiChannel 
                                        });
                                        
                                        processedNotesLog.push(
                                            `[Ch${channelIndex+1} Bar${barIndex+1}, Note${noteIndex}] PITCH:${pitchValue}, START:${noteOnTick}t, DURATION:${midiDuration}t, VEL:${velocity}`
                                        );
                                    } else {
                                         processedNotesLog.push(
                                            `[Ch${channelIndex+1} Bar${barIndex+1}, Note${noteIndex}] PITCH:${pitchValue}, START:CONTINUES, DURATION:${midiDuration}t, VEL:${velocity} (ã‚¿ã‚¤ç¶™ç¶š)`
                                        );
                                    }
                                    
                                    allEvents.push({
                                        tick: noteOffTick, 
                                        type: MIDI_NOTE_OFF, 
                                        pitch: pitchValue, 
                                        velocity: 0, 
                                        channel: midiChannel 
                                    });
                                    
                                    noteCount++; 
                                }

                                // 4. ãƒ”ãƒƒãƒãƒ™ãƒ³ãƒ‰ãƒ»ãã®ä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’åé›†
                                if (pointsValid) {
                                    for (const point of note.points) {
                                        const pointTick = absoluteBarStartTick + midiStart + Math.round(point.tick * tickScaleFactor);
                                        
                                        if (typeof point.pitchBend === 'number') {
                                            const [lsb, msb] = convertPitchBend(point.pitchBend);
                                            allEvents.push({
                                                tick: pointTick, 
                                                type: MIDI_PITCH_BEND_CHANGE, 
                                                value1: lsb, 
                                                value2: msb, 
                                                channel: midiChannel 
                                            });
                                        }
                                    }
                                    
                                    // ãƒãƒ¼ãƒˆçµ‚äº†æ™‚ã«ãƒ”ãƒƒãƒãƒ™ãƒ³ãƒ‰ãƒªã‚»ãƒƒãƒˆ
                                    allEvents.push({
                                        tick: noteOffTick, 
                                        type: MIDI_PITCH_BEND_CHANGE, 
                                        value1: PITCH_BEND_RESET_LSB, 
                                        value2: PITCH_BEND_RESET_MSB, 
                                        channel: midiChannel 
                                    });
                                }
                            }
                        } else {
                             skippedEvents.push(`[Ch${channelIndex+1} Bar${barIndex+1}] ç†ç”±: å‚ç…§ã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã¯æœ‰åŠ¹ã§ã™ãŒã€éŸ³ç¬¦ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ (notes: [])`);
                        }
                    } else {
                        let rawValue = diagnosticInfo.value;
                        if (typeof rawValue === 'object' && rawValue !== null) {
                            rawValue = JSON.stringify(rawValue).substring(0, 200) + (JSON.stringify(rawValue).length > 200 ? '...' : ''); 
                        }
                        
                        let logMessage = `[Ch${channelIndex+1} Bar${barIndex+1}] ç†ç”±: ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•— (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${diagnosticInfo.status})`;
                        logMessage += `\n>> è¨ºæ–­æƒ…å ±:`;
                        logMessage += `\nå‚ç…§ãƒ‡ãƒ¼ã‚¿å‹: ${diagnosticInfo.type}`;
                        logMessage += `\nå€¤ã®æ¦‚ç•¥: ${rawValue}`;
                        logMessage += `\nã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚­ãƒ¼: ${diagnosticInfo.keys || 'N/A'}`;
                        logMessage += `\næ¤œç´¢é †åº: ${diagnosticInfo.searchOrder.join(' -> ') || 'N/A'}`;
                        
                        skippedEvents.push(logMessage);
                    }
                    absoluteBarStartTick += midiTicksPerBar; 
                }
            }
            
            // 5. å…¨ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ†ã‚£ãƒƒã‚¯ã§ã‚½ãƒ¼ãƒˆ
            allEvents.sort((a, b) => a.tick - b.tick);
            
            const trackEvents = [];
            let lastTick = 0;

            // 6. ã‚·ãƒ³ã‚°ãƒ«ãƒ»ãƒˆãƒ©ãƒƒã‚¯ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆã®æ›¸ãè¾¼ã¿
            for (const event of allEvents) {
                const deltaTime = event.tick - lastTick;
                const actualDelta = Math.max(0, deltaTime);
                const deltaBytes = writeVariableLengthQuantity(actualDelta);
                
                // --- ã‚¤ãƒ™ãƒ³ãƒˆæ›¸ãè¾¼ã¿ãƒ­ã‚¸ãƒƒã‚¯ (ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¦æ­¢) ---
                
                if (event.type === MIDI_NOTE_ON || event.type === MIDI_NOTE_OFF) {
                    trackEvents.push(
                        ...deltaBytes, 
                        event.type | event.channel, // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚¤ãƒˆ (Chä»˜ã)
                        event.pitch, 
                        event.velocity 
                    );
                } else if (event.type === MIDI_PROGRAM_CHANGE) {
                     trackEvents.push(
                        ...deltaBytes, 
                        event.type | event.channel, // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚¤ãƒˆ (Chä»˜ã)
                        event.value1
                    );
                } else if (event.type === MIDI_PITCH_BEND_CHANGE) { 
                     trackEvents.push(
                        ...deltaBytes, 
                        event.type | event.channel, // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚¤ãƒˆ (Chä»˜ã)
                        event.value1, // LSB
                        event.value2  // MSB
                    );
                } else if (event.type === MIDI_CONTROL_CHANGE) { 
                     trackEvents.push(
                        ...deltaBytes, 
                        event.type | event.channel, // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚¤ãƒˆ (Chä»˜ã)
                        event.value1, // CCç•ªå·
                        event.value2  // CCå€¤
                    );
                } else if (event.type === MIDI_META) { 
                    // ãƒ¡ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆ (ãƒ†ãƒ³ãƒã€ãƒˆãƒ©ãƒƒã‚¯åãªã©)
                    trackEvents.push(
                        ...deltaBytes, 
                        event.type, 
                        event.metaType, 
                        ...writeVariableLengthQuantity(event.data.length), 
                        ...event.data
                    );
                }
                
                lastTick = event.tick;
            }

            // 7. ãƒˆãƒ©ãƒƒã‚¯çµ‚äº†
            trackEvents.push(
                ...writeVariableLengthQuantity(0), MIDI_META, MIDI_END_OF_TRACK, 0x00 
            );
            
            const trackSize = trackEvents.length;
            const trackChunk = [
                ...writeUint32(MIDI_TRACK_CHUNK), 
                ...writeUint32(trackSize), 
                ...trackEvents
            ];

            // 8. ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒˆãƒ©ãƒƒã‚¯ãƒãƒ£ãƒ³ã‚¯ã‚’çµåˆ
            const totalTracks = 1; 
            const header = [
                ...writeUint32(MIDI_HEADER_CHUNK), ...writeUint32(6), 
                ...writeUint16(MIDI_FORMAT_SINGLE_TRACK), // MIDIå½¢å¼0 (ã‚·ãƒ³ã‚°ãƒ«ãƒ»ãƒˆãƒ©ãƒƒã‚¯)
                ...writeUint16(totalTracks), 
                ...writeUint16(MIDI_TICKS_PER_BEAT) 
            ];

            const fullMidi = [
                ...header, 
                ...trackChunk 
            ];

            return { 
                midiBuffer: new Uint8Array(fullMidi).buffer,
                noteCount: noteCount, 
                skippedEvents: skippedEvents,
                processedNotesLog: processedNotesLog, 
                summary: logDetailsSummary 
            }; 
        }

        // ----------------------------------------------------------------------
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ (v57.0)
        // ----------------------------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('jsonFile');
            
            showMessage('âœ… å¤‰æ›æ©Ÿèƒ½ã®æº–å‚™å®Œäº†ã€‚JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'success');
            updateLogDisplay('ã“ã“ã«å¤‰æ›ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚');

            fileInput.addEventListener('change', (e) => {
                showMessage('', 'none');
                convertButton.disabled = true;
                logDownloadContainer.innerHTML = '';
                updateLogDisplay('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ä¸­...');

                const file = e.target.files[0];
                
                if (!file) return;

                showMessage(`ğŸ” ãƒ•ã‚¡ã‚¤ãƒ« [${file.name}] ã®èª­ã¿è¾¼ã¿ã‚’é–‹å§‹ã—ã¾ã—ãŸ...`, 'success'); 

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const ultraBoxData = JSON.parse(event.target.result);
                        
                        if (ultraBoxData && (ultraBoxData.format === "UltraBox" || ultraBoxData.format === "BeepBox")) {
                            convertButton.ultraBoxData = ultraBoxData;
                            convertButton.fileName = file.name.replace(/\.json$/i, ''); 
                            convertButton.disabled = false;
                            showMessage(`âœ… ã€Œ${file.name}ã€ã®èª­ã¿è¾¼ã¿ã«æˆåŠŸã—ã¾ã—ãŸã€‚å¤‰æ›ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`, 'success');
                            updateLogDisplay('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸã€‚å¤‰æ›ã‚’å¾…æ©Ÿã—ã¦ã„ã¾ã™ã€‚');
                        } else {
                            throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒUltraBox/BeepBoxã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`);
                        }
                    } catch (error) {
                        showMessage(`âŒ ãƒ•ã‚¡ã‚¤ãƒ«è§£æå¤±æ•—: ${error.message}`, 'error');
                        updateLogDisplay(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                        convertButton.ultraBoxData = null;
                    }
                };
                
                reader.readAsText(file);
            });

            convertButton.addEventListener('click', () => {
                if (!convertButton.ultraBoxData) {
                    showMessage('âŒ å¤‰æ›ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚', 'error');
                    return;
                }

                convertButton.disabled = true;
                logDownloadContainer.innerHTML = ''; 
                showMessage('ğŸ”„ MIDIã¸ã®å¤‰æ›ã‚’é–‹å§‹ã—ã¾ã—ãŸ... (MIDIå½¢å¼0 - ãƒ”ãƒƒãƒãƒ™ãƒ³ãƒ‰ãƒ¬ãƒ³ã‚¸ä¿®æ­£)', 'warning');
                updateLogDisplay('MIDIãƒ‡ãƒ¼ã‚¿ç”Ÿæˆä¸­...');
                
                const baseFileName = convertButton.fileName;
                
                try {
                    const result = convertUltraBoxToMidi(convertButton.ultraBoxData);
                    
                    const midiFileName = baseFileName + `_format0_v57_0.mid`;
                    
                    // 1. MIDIãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (è‡ªå‹•)
                    downloadFile(result.midiBuffer, midiFileName, "audio/midi");
                    
                    // 2. ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä½œæˆ
                    const fileSize = result.midiBuffer.byteLength;
                    let logContent = `${result.summary}\n\n`;
                    logContent += `--- ã‚¹ã‚­ãƒƒãƒ—ãƒ»ãƒ‘ã‚¿ãƒ¼ãƒ³å–å¾—å¤±æ•— è©³ç´°ãƒ­ã‚° (å…¨ ${result.skippedEvents.length}å€‹) ---\n`;
                    logContent += result.skippedEvents.length > 0 ? result.skippedEvents.join('\n\n') : "ã€æˆåŠŸã€‘ãƒ‘ã‚¿ãƒ¼ãƒ³å‚ç…§ã‚¨ãƒ©ãƒ¼ã‚„å‡¦ç†ä¸èƒ½ãªéŸ³ç¬¦ãƒ‡ãƒ¼ã‚¿ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚";
                    
                    logContent += `\n\n--- å‡¦ç†ã•ã‚ŒãŸéŸ³ç¬¦ è©³ç´°ãƒ­ã‚° (å…¨ ${result.noteCount}å€‹) ---\n`;
                    logContent += `MIDIãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${fileSize} ãƒã‚¤ãƒˆ\n`;


                    if (result.noteCount > 0) {
                        if (result.noteCount <= MAX_DETAIL_LOG_NOTES) {
                            logContent += `âœ… ãƒãƒ¼ãƒˆæ•°ãŒ${MAX_DETAIL_LOG_NOTES}å€‹ä»¥ä¸‹ã®ãŸã‚ã€å…¨è©³ç´°ãƒ­ã‚°ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚\n`;
                            logContent += `å¼•ãç¶šãéŸ³ãŒå‡ºãªã„å ´åˆã¯ã€ã“ã®ãƒ­ã‚°ã‚’å…¨ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ã”é€£çµ¡ãã ã•ã„ã€‚\n`;
                            logContent += result.processedNotesLog.join('\n'); 
                        } else { 
                            logContent += `âš ï¸ ãƒãƒ¼ãƒˆç·æ•°ãŒ${result.noteCount}å€‹ã®ãŸã‚ã€è©³ç´°ãƒ­ã‚°ã®å‡ºåŠ›ã¯çœç•¥ã—ã¾ã—ãŸã€‚\n`;
                            logContent += `æœ€åˆã®${MAX_DETAIL_LOG_NOTES}å€‹ã®ãƒãƒ¼ãƒˆãƒ­ã‚°:\n`;
                            logContent += result.processedNotesLog.slice(0, MAX_DETAIL_LOG_NOTES).join('\n');
                            logContent += `\n...(ãƒ­ã‚°çœç•¥ã€‚å…¨ãƒ­ã‚°ã¯${midiFileName.replace('.mid', '_log.txt')}ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„)`;
                        }
                    } else {
                        logContent += "ã€å¤±æ•—ã€‘éŸ³ç¬¦ãƒ‡ãƒ¼ã‚¿ãŒä¸€ã¤ã‚‚ç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚";
                    }

                    // 3. ãƒ­ã‚°ã®è¡¨ç¤ºã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®è¡¨ç¤º
                    displayLogButton(logContent, baseFileName, false); 
                    
                    if (result.noteCount > 0) {
                        showMessage(
                            `ğŸ‰ å¤‰æ›å®Œäº†ï¼**MIDIãƒ•ã‚¡ã‚¤ãƒ«**ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚(ãƒãƒ¼ãƒˆç·æ•°: ${result.noteCount}å€‹)ã€‚**éŸ³ãŒæ”¹å–„ã•ã‚ŒãŸã‹**ã”ç¢ºèªãã ã•ã„ã€‚`, 
                            'success'
                        );
                    } else {
                        showMessage(
                            `ğŸ’¥ å¤‰æ›å®Œäº†ã€‚**ã—ã‹ã—ã€éŸ³ç¬¦ãƒ‡ãƒ¼ã‚¿ãŒä¸€ã¤ã‚‚ç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚** ãƒ­ã‚°ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`, 
                            'error'
                        );
                    }
                    
                    convertButton.disabled = false;

                } catch (error) {
                    
                    let errorLogContent = `ã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${CONVERTER_VERSION}\n`;
                    errorLogContent += `--- ğŸ’¥ è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãƒ­ã‚° ---\n`;
                    errorLogContent += `ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${error.message}\n`;
                    errorLogContent += `ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ (ã‚ã‚Œã°):\n${error.stack || "N/A"}\n\n`;
                    
                    displayLogButton(errorLogContent, baseFileName, true); 

                    showMessage(`ğŸ’¥ å¤‰æ›å‡¦ç†ä¸­ã«è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}ã€‚ãƒ­ã‚°ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`, 'error');
                    convertButton.disabled = false;
                }
            });
        });
    </script>

</body>
</html>
